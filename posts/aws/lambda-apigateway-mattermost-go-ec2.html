<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>透過 AWS Lambda、API Gateway 和 AWS Go SDK，從 Mattermost 查看/開關 EC2 Instances | Oscar&#39;s Pathways</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    <link rel="mask-icon" href="/logo.svg" color="#333333">
    <link rel="alternate" type="application/rss+xml" href="http://lytzeng.github.io/rss.xml" title="Oscar&#39;s Pathways RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="http://lytzeng.github.io/feed.atom" title="Oscar&#39;s Pathways Atom Feed">
    <link rel="alternate" type="application/json" href="http://lytzeng.github.io/feed.json" title="Oscar&#39;s Pathways JSON Feed"><link rel='canonical' href='http://lytzeng.github.io/posts/aws/lambda-apigateway-mattermost-go-ec2.html'/>
    <meta name="description" content="目前我實習的公司使用 Mattermost 作為內部通訊軟體，且 Mattermost 支援 Webhook 和 Slash Command。為了方便隨時隨地可以快速開啟/關閉 EC2，因此想寫一個下 Slash Command 指令的工具，直接呼叫 API 來控制和查看 EC2，免去登入 console 的麻煩，一定會方便許多。我使用 Go 寫了一個程式處理 Mattermost 傳入的資料，並且透過 aws-sdk-go 對 EC2 進行操作。程式會在 Lambda 上執行，原始碼請參考我的 Github：https://github.com/LYTzeng/ec2ctl，日後考慮用 CloudFormation 讓需要的人快速佈署。這篇主要會介紹 API Gateway、Lambda 和部份 SDK 的使用。">
    <meta name="image" content="http://lytzeng.github.io/images/aws/lambda-apigateway-mattermost-go-ec2-1.jpg">
    <meta name="twitter:title" content="透過 AWS Lambda、API Gateway 和 AWS Go SDK，從 Mattermost 查看/開關 EC2 Instances">
    <meta name="twitter:description" content="目前我實習的公司使用 Mattermost 作為內部通訊軟體，且 Mattermost 支援 Webhook 和 Slash Command。為了方便隨時隨地可以快速開啟/關閉 EC2，因此想寫一個下 Slash Command 指令的工具，直接呼叫 API 來控制和查看 EC2，免去登入 console 的麻煩，一定會方便許多。我使用 Go 寫了一個程式處理 Mattermost 傳入的資料，並且透過 aws-sdk-go 對 EC2 進行操作。程式會在 Lambda 上執行，原始碼請參考我的 Github：https://github.com/LYTzeng/ec2ctl，日後考慮用 CloudFormation 讓需要的人快速佈署。這篇主要會介紹 API Gateway、Lambda 和部份 SDK 的使用。">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="http://lytzeng.github.io/images/aws/lambda-apigateway-mattermost-go-ec2-1.jpg">
    <meta name="twitter:url" content="http://lytzeng.github.io/posts/aws/lambda-apigateway-mattermost-go-ec2.html">
    <meta property="og:type" content="article">
    <meta property="og:title" content="透過 AWS Lambda、API Gateway 和 AWS Go SDK，從 Mattermost 查看/開關 EC2 Instances">
    <meta property="og:description" content="目前我實習的公司使用 Mattermost 作為內部通訊軟體，且 Mattermost 支援 Webhook 和 Slash Command。為了方便隨時隨地可以快速開啟/關閉 EC2，因此想寫一個下 Slash Command 指令的工具，直接呼叫 API 來控制和查看 EC2，免去登入 console 的麻煩，一定會方便許多。我使用 Go 寫了一個程式處理 Mattermost 傳入的資料，並且透過 aws-sdk-go 對 EC2 進行操作。程式會在 Lambda 上執行，原始碼請參考我的 Github：https://github.com/LYTzeng/ec2ctl，日後考慮用 CloudFormation 讓需要的人快速佈署。這篇主要會介紹 API Gateway、Lambda 和部份 SDK 的使用。">
    <meta property="og:image" content="http://lytzeng.github.io/images/aws/lambda-apigateway-mattermost-go-ec2-1.jpg">
    <meta property="og:url" content="http://lytzeng.github.io/posts/aws/lambda-apigateway-mattermost-go-ec2.html">
    <meta property="article:tag" content="go">
    <meta itemprop="name" content="透過 AWS Lambda、API Gateway 和 AWS Go SDK，從 Mattermost 查看/開關 EC2 Instances">
    <meta itemprop="description" content="目前我實習的公司使用 Mattermost 作為內部通訊軟體，且 Mattermost 支援 Webhook 和 Slash Command。為了方便隨時隨地可以快速開啟/關閉 EC2，因此想寫一個下 Slash Command 指令的工具，直接呼叫 API 來控制和查看 EC2，免去登入 console 的麻煩，一定會方便許多。我使用 Go 寫了一個程式處理 Mattermost 傳入的資料，並且透過 aws-sdk-go 對 EC2 進行操作。程式會在 Lambda 上執行，原始碼請參考我的 Github：https://github.com/LYTzeng/ec2ctl，日後考慮用 CloudFormation 讓需要的人快速佈署。這篇主要會介紹 API Gateway、Lambda 和部份 SDK 的使用。">
    <meta itemprop="image" content="http://lytzeng.github.io/images/aws/lambda-apigateway-mattermost-go-ec2-1.jpg">
    <meta name="theme-color" content="#333333">
    <meta prefix="og: http://ogp.me/ns#" property="og:article:author" content="Li-Yen Tseng">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#333333">
    <meta name="google-site-verification" content="luVocIl3165-z3eRtc2ux4f0_QqyqMiauRI-fD0GoJ0">
    <link rel="preload" href="/assets/css/0.styles.58b086f6.css" as="style"><link rel="preload" href="/assets/js/app.734983b6.js" as="script"><link rel="preload" href="/assets/js/2.4abc6c77.js" as="script"><link rel="preload" href="/assets/js/3.24286270.js" as="script"><link rel="preload" href="/assets/js/9.2acc88bd.js" as="script"><link rel="prefetch" href="/assets/js/10.0fe316ce.js"><link rel="prefetch" href="/assets/js/11.c2f0e8df.js"><link rel="prefetch" href="/assets/js/12.7d2f5e95.js"><link rel="prefetch" href="/assets/js/13.d37c2d82.js"><link rel="prefetch" href="/assets/js/14.fdb85dfc.js"><link rel="prefetch" href="/assets/js/15.74b02e26.js"><link rel="prefetch" href="/assets/js/16.5d3a301d.js"><link rel="prefetch" href="/assets/js/17.5591eb7b.js"><link rel="prefetch" href="/assets/js/18.fff40bd9.js"><link rel="prefetch" href="/assets/js/19.7a1b3939.js"><link rel="prefetch" href="/assets/js/20.5b429bc6.js"><link rel="prefetch" href="/assets/js/21.1ddd6459.js"><link rel="prefetch" href="/assets/js/22.938ad97b.js"><link rel="prefetch" href="/assets/js/23.74617305.js"><link rel="prefetch" href="/assets/js/24.6abd4844.js"><link rel="prefetch" href="/assets/js/25.60e33ca5.js"><link rel="prefetch" href="/assets/js/26.e0c91c2e.js"><link rel="prefetch" href="/assets/js/27.74e19b9e.js"><link rel="prefetch" href="/assets/js/28.99756806.js"><link rel="prefetch" href="/assets/js/29.64a9a864.js"><link rel="prefetch" href="/assets/js/30.072288c8.js"><link rel="prefetch" href="/assets/js/31.5e1fee3b.js"><link rel="prefetch" href="/assets/js/32.48dcf787.js"><link rel="prefetch" href="/assets/js/33.ba19ce5b.js"><link rel="prefetch" href="/assets/js/34.25b08d25.js"><link rel="prefetch" href="/assets/js/35.02d2dca8.js"><link rel="prefetch" href="/assets/js/36.b1971acd.js"><link rel="prefetch" href="/assets/js/37.9b066a16.js"><link rel="prefetch" href="/assets/js/38.a006327f.js"><link rel="prefetch" href="/assets/js/4.7e77c6cc.js"><link rel="prefetch" href="/assets/js/5.fdc84017.js"><link rel="prefetch" href="/assets/js/6.8d73f1bb.js"><link rel="prefetch" href="/assets/js/7.8e216ccf.js"><link rel="prefetch" href="/assets/js/8.c634d950.js">
    <link rel="stylesheet" href="/assets/css/0.styles.58b086f6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="Oscar's Pathways" class="logo"> <span class="site-name can-hide">Oscar's Pathways</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/categories/" class="nav-link">Categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><div class="bio bio-sidebar"><div class="img-holder"><img src="/bio.jpg"></div> <p class="name">Oscar Tseng</p> <div style="border-bottom: 1px solid hsl(0, 0%, 30%); border-top: 1px solid hsl(0, 0%, 30%);"><div style="display: inline-block; padding: 0 10px; border-right: 1px solid hsl(0, 0%, 30%); margin: 5px 0"><a href="/categories/"><span style="display:block;font-family:'Noto Sans TC Medium';font-size:20px;">13</span> <span>Posts</span></a></div> <div style="display: inline-block; padding: 0 10px; margin: 5px 0"><a href="/tags/"><span style="display:block;font-family:'Noto Sans TC Medium';font-size:20px;">16</span> <span>Tags</span></a></div></div> <div style="display: flex; justify-content: center; padding-top: 5px; padding-bottom: 5px; border-bottom: 1px solid hsl(0, 0%, 30%);"><span style="width: 32px; height: 32px;"><a href="https://github.com/LYTzeng" target="_blank" rel="noopener" title="Github"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path fill-rule="evenodd" d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45 3 3 0 0 0 4.08 1.16 2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76 5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7 5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z"></path></svg></a></span> <span style="width: 32px; height: 32px;"><a href="https://www.linkedin.com/in/li-yen-tseng/" target="_blank" rel="noopener" title="Linkedin"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path d="M26.21 4H5.79A1.78 1.78 0 0 0 4 5.73V26.2a1.77 1.77 0 0 0 1.79 1.73h20.42A1.77 1.77 0 0 0 28 26.2V5.73A1.78 1.78 0 0 0 26.21 4zm-15.1 20.41H7.59V13h3.52zm-1.72-13a2.07 2.07 0 0 1-2.07-2.02 2 2 0 0 1 2.07-2.07 2.07 2.07 0 0 1 0 4.13zm15.09 12.93H21v-5.58c0-1.33 0-3.06-1.86-3.06S17 17.16 17 18.63v5.65h-3.56V13h3.32v1.5h.07a3.72 3.72 0 0 1 3.39-1.86c3.59 0 4.26 2.4 4.26 5.45z"></path></svg></a></span> <span style="width: 32px; height: 32px;"><a href="mailto:oscar217b@gmail.com" target="_blank" rel="noopener" title="mail"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path d="M28 6H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2zm-2.2 2L16 14.78 6.2 8zM4 24V8.91l11.43 7.91a1 1 0 0 0 1.14 0L28 8.91V24z"></path><title>Email</title></svg></a></span> <span style="width: 32px; height: 32px;"><a href="/rss.xml" target="_blank" rel="noopener" title="rss" type="application/rss+xml"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path d="M8 18c-3.3 0-6 2.7-6 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6zm0 10c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4zm22-4h-2C28 13 19 4 8 4V2c12.1 0 22 9.9 22 22z"></path><path d="M22 24h-2c0-6.6-5.4-12-12-12v-2c7.7 0 14 6.3 14 14z"></path><title>Rss</title></svg></a></span> <span style="width: 32px; height: 32px;"><a href="https://netlab.csie.ntut.edu.tw" target="_blank" rel="noopener" title="NTUT CSIE Netlab" type="application/rss+xml"><img src="/Netlab-new-icon-darktheme.svg" style="width: 32px; height: 32px;"></a></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/categories/" class="nav-link">Categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>透過 AWS Lambda、API Gateway 和 AWS Go SDK，從 Mattermost 查看/開關 EC2 Instances</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#api-gateway" class="sidebar-link">API Gateway</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#iam-role" class="sidebar-link">IAM Role</a></li><li class="sidebar-sub-header"><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#建立-api-gateway" class="sidebar-link">建立 API Gateway</a></li></ul></li><li><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#lambda" class="sidebar-link">Lambda</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#iam-role-2" class="sidebar-link">IAM Role</a></li><li class="sidebar-sub-header"><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#建立-function" class="sidebar-link">建立 Function</a></li></ul></li><li><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#mattermost-架設與設定" class="sidebar-link">Mattermost 架設與設定</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#使用-mattermost-測試" class="sidebar-link">使用 Mattermost 測試</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#使用-postman-測試" class="sidebar-link">使用 Postman 測試</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html#references" class="sidebar-link">References</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> <div class="sidebar-links"><p class="sidebar-heading"><span>近期文章</span></p> <ul><li><a href="/posts/aws/lambda-apigateway-mattermost-go-ec2.html" class="sidebar-link recentTitle">透過 AWS Lambda、API Gateway 和 AWS Go SDK，從 Mattermost 查看/開關 EC2 Instances</a></li><li><a href="/posts/infra/monitoring-pfsense-via-kibana.html" class="sidebar-link recentTitle">ELK Stack 整合 pfSense (三)：Kibana Dashboard</a></li><li><a href="/posts/infra/elasticsearch-receives-data-from-logstash.html" class="sidebar-link recentTitle">ELK Stack 整合 pfSense (二)：Elasticsearch</a></li><li><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html" class="sidebar-link recentTitle">ELK Stack 整合 pfSense (一)：將 pfSense 防火牆阻擋紀錄傳送到 Logstash</a></li><li><a href="/posts/misc/Installing-macOS-on-ESXi.html" class="sidebar-link recentTitle">想擁有一台伺服器等級 Mac? macOS 10.15 Catalina on VMware ESXi 6.7</a></li></ul></div> <div class="sidebar-links"><p class="sidebar-heading"><span>Tags</span></p> <div class="tags sidebar-tags sidebar-link"><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/go"><div>go
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/aws lambda"><div>aws lambda
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/aws ec2"><div>aws ec2
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/aws api gateway"><div>aws api gateway
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/VuePress"><div>VuePress
        <div class="tagcount">3</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/ELK"><div>ELK
        <div class="tagcount">3</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/pfSense"><div>pfSense
        <div class="tagcount">4</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/VMware"><div>VMware
        <div class="tagcount">3</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/vSphere"><div>vSphere
        <div class="tagcount">3</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/OpenVPN"><div>OpenVPN
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/MacOS"><div>MacOS
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/心得想法"><div>心得想法
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/Mininet"><div>Mininet
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/OpenFlow"><div>OpenFlow
        <div class="tagcount">2</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/Ryu"><div>Ryu
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/Python"><div>Python
        <div class="tagcount">1</div></div></a></span></span></div></div> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="透過-aws-lambda、api-gateway-和-aws-go-sdk，從-mattermost-查看-開關-ec2-instances"><a href="#透過-aws-lambda、api-gateway-和-aws-go-sdk，從-mattermost-查看-開關-ec2-instances" class="header-anchor">#</a> 透過 AWS Lambda、API Gateway 和 AWS Go SDK，從 Mattermost 查看/開關 EC2 Instances</h1> <div class="page-edit"><div title="最後更新" class="timestamp"><span class="prefix"><svg fill="#ececec" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true" style="display: inline-block; vertical-align: middle; will-change: transform;"><path d="M2 27H30V29H2zM25.41 9a2 2 0 0 0 0-2.83L21.83 2.59a2 2 0 0 0-2.83 0l-15 15V24h6.41zm-5-5L24 7.59l-3 3L17.41 7zM6 22V18.41l10-10L19.59 12l-10 10z"></path><title>Calendar</title></svg></span> <span class="time">4/21/2020, 2:25:11 AM</span></div> <div title="建立時間" class="timestamp"><span class="prefix"><svg fill="#ececec" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true" style="display: inline-block; vertical-align: middle; will-change: transform;"><path d="M26 4.03h-4v-2h-2v2h-8v-2h-2v2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h20a2 2 0 0 0 2-2v-20a2 2 0 0 0-2-2zm0 22H6v-14h20zm0-16H6v-4h4v2h2v-2h8v2h2v-2h4z"></path><title>Calendar</title></svg></span> <span class="time">4/21/2020, 2:19:34 AM</span></div></div> <div><div class="taglinks"><a href="/categories/#AWS"><div style="display:inline;"><svg fill="#14cdef" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true" style="display:inline-block;vertical-align:middle;will-change:transform;"><path d="M11.17 6l3.42 3.41.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z"></path><title>Folder</title></svg></div>
  AWS</a> <a href="/tags/go"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>go</span></a><a href="/tags/aws lambda"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>aws lambda</span></a><a href="/tags/aws ec2"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>aws ec2</span></a><a href="/tags/aws api gateway"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>aws api gateway</span></a></div></div> <p>目前我實習的公司使用 Mattermost 作為內部通訊軟體，且 Mattermost 支援 Webhook 和 Slash Command。為了方便隨時隨地可以快速開啟/關閉 EC2，因此想寫一個下 Slash Command 指令的工具，直接呼叫 API 來控制和查看 EC2，免去登入 console 的麻煩，一定會方便許多。整體架構如下。</p> <p><img alt="" data-src="/images/aws/lambda-apigateway-mattermost-go-ec2-1.jpg" loading="lazy" class="lazy"></p> <p>我使用 Go 寫了一個程式處理 Mattermost 傳入的資料，並且透過 <a href="https://github.com/aws/aws-sdk-go" target="_blank" rel="noopener noreferrer">aws-sdk-go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 對 EC2 進行操作。程式會在 Lambda 上執行，原始碼請參考我的 Github：<a href="https://github.com/LYTzeng/ec2ctl" target="_blank" rel="noopener noreferrer">https://github.com/LYTzeng/ec2ctl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，日後考慮用 CloudFormation 讓需要的人快速佈署。這篇主要會介紹 API Gateway、Lambda 和部份 SDK 的使用。</p> <p>先展示成果：</p> <p><img alt="" data-src="https://i.imgur.com/PEndaZv.gif" loading="lazy" class="lazy"></p> <h2 id="api-gateway"><a href="#api-gateway" class="header-anchor">#</a> API Gateway</h2> <h3 id="iam-role"><a href="#iam-role" class="header-anchor">#</a> IAM Role</h3> <p>在建立一個 API 之前，我們先創一個 IAM Policy 並 Attach 到 Role。API Gateway 需要 Invoke Lambda 以及寫入 CLoudWatch 的權限。
進入 IAM 管理介面，首先 Create 一個 Policy 使其允許 Invoke Lambda，我們使用 JSON 來建立 Policy：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Sid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VisualEditor0&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;lambda:InvokeFunction&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;lambda:PutFunctionEventInvokeConfig&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;*&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接著建立一個 Role 並 <strong>Attach policies</strong>。除了 attach 剛才建立的 policy，還需要 attach 一個 <code>AmazonAPIGatewayPushToCloudWatchLogs</code> 的 policy，可以直接搜尋，順便將 <strong>Role ARN</strong>複製下來，之後會使用到。接下來就可以建立一個 API。</p> <p><img alt="" data-src="https://i.imgur.com/QmuRVgE.png" loading="lazy" class="lazy"></p> <h3 id="建立-api-gateway"><a href="#建立-api-gateway" class="header-anchor">#</a> 建立 API Gateway</h3> <p>進入 API Gateway 介面，選擇 <strong>Create API</strong>，找到 <strong>REST API</strong> 選擇 Build，<strong>Choose the protocol</strong> 選 <strong>REST</strong>，<strong>Create new API</strong> 選擇 <strong>New PIA</strong>。<strong>API Name</strong>輸入 API 名稱，<strong>Endpoint Type</strong> 保留預設 <strong>Regional</strong> 即可。</p> <p><img alt="" data-src="https://i.imgur.com/G4IZFLx.png" loading="lazy" class="lazy"></p> <p><strong>Create API</strong> 後進入 API 設定的頁面。選擇左側選單最下面的 <strong>Settings</strong>，將之前複製的 <strong>Role ARN</strong> 貼上，<strong>Role ARN</strong> 就是一個 IAM Role 的 ID，這可以提供 API Gateway 寫入 CloudWatch 的權限。</p> <p><img alt="" data-src="https://i.imgur.com/jhhmCyx.png" loading="lazy" class="lazy"></p> <p>API Gateway 幾個組成元素大概有 <strong>Resource</strong>、<strong>Method</strong>、<strong>Stages</strong> 和 <strong>Resource Policy</strong>，這幾點設置完畢就能有一個可以運作的簡單 API 了。先簡單說明這幾個項目：</p> <ul><li><p><strong>Resources</strong>
一個 Resource 可以接收多種的 HTTP request method，例如 GET/POST/OPTION 等等。 Resource 的名稱會包含在 URL 裡面。</p></li> <li><p><strong>Methods</strong>
HTTP request 的單一種類，並且決定接收到這個 method 後下一步該做什麼，以及如何做出 response。例如：收到 HTTP POST 時 觸發 Lambda function，並且將 body 傳送至 Lambda，隨後將 Lambda 回傳的 response (如：402 Unauthorized) 回應給 Client。流程會顯示在設定頁面中。
<img alt="" data-src="https://i.imgur.com/jqrJpru.png" loading="lazy" class="lazy"></p></li> <li><p><strong>Stages</strong>
Stage 代表這個 API 的開發階段，例如 <code>dev, prod, beta, v2</code>等，要產生一個可以被呼叫的 API，一定要 <strong>Deploy</strong> 到一個 Stage，Stage 的名稱會包含在 URL 中。</p></li> <li><p><strong>Resource Policy</strong>
提供 API 存取控制的機制，使用 JSON 格式來設定，條件可以使用 IAM，或是單一主機 IP等，可用來決定
被允許/禁止的動作，避免被不明人士存取到 API。</p></li></ul> <p>API Gateway 的 REST API 的 URL 的格式為：</p> <div class="language- extra-class"><pre class="language-text"><code>https://{restapi-id}.execute-api.{region}.amazonaws.com/{stageName}/{resource}
</code></pre></div><p>假設我建立一個名為 <code>ec2ctl</code> 的 <strong>resource</strong>，<strong>stage</strong> 為 <code>dev</code>，API 位於 <code>us-west-2</code> 的 region，則我的 API URL 會是 <code>https://{restapi-id}.execute-api.us-west-2.amazonaws.com/dev/ec2ctl</code> 。</p> <h4 id="建立-resource"><a href="#建立-resource" class="header-anchor">#</a> 建立 Resource</h4> <p>左側選單選擇 <strong>Resources</strong>，會看到只有<code>/</code>這個符號，代表我們位於 base url，點擊 <strong>Action</strong> &gt; <strong>Create Resource</strong> 建立 Resource，並決定 <strong>resource name</strong> 與 <strong>resource path</strong>。
<img alt="" data-src="https://i.imgur.com/IJYR2UF.png" loading="lazy" class="lazy"></p> <h4 id="建立-method"><a href="#建立-method" class="header-anchor">#</a> 建立 Method</h4> <p>選擇 Action &gt; Create Method，並選擇 POST。
<img alt="" data-src="https://i.imgur.com/GImWVwX.png" loading="lazy" class="lazy"> <img alt="" data-src="https://i.imgur.com/RpvVp6E.png" loading="lazy" class="lazy"></p> <h4 id="resource-policy"><a href="#resource-policy" class="header-anchor">#</a> Resource Policy</h4> <p>我們需要允許 API Gateway invoke Lambda funciton，而且只有 Mattermost server 和我們的測試主機的 <strong>SourceIp</strong> 是被允許的，使用 JSON 格式輸入設定。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Principal&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;AWS&quot;</span><span class="token operator">:</span> <span class="token string">&quot;*&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;execute-api:Invoke&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;execute-api:/*/*/ec2ctl&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;IpAddress&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;aws:SourceIp&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token string">&quot;192.0.2.1/32&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;192.0.2.2/32&quot;</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="deploy-api-到指定-stage"><a href="#deploy-api-到指定-stage" class="header-anchor">#</a> Deploy API 到指定 Stage</h4> <p>點選左側選單 <strong>Resources</strong>，<strong>Action</strong> &gt; <strong>Deploy API</strong>，<strong>[New Stage]</strong> 後輸入 stage name，deploy 後即可使用這個 API。
<img alt="" data-src="https://i.imgur.com/IlIV3He.png" loading="lazy" class="lazy"></p> <p>有一點需要特別注意的是，<mark>對 API 設定做任何更動後，請記得要重新 <strong>Deploy</strong> 才會生效</mark>。</p> <p>接著我們需要使用 Lambda 來和 API Gateway 串接。</p> <h2 id="lambda"><a href="#lambda" class="header-anchor">#</a> Lambda</h2> <h3 id="iam-role-2"><a href="#iam-role-2" class="header-anchor">#</a> IAM Role</h3> <p>我們會使用 Lambda 達成幾項功能：讀取所有 region 的 EC2，並回傳相關資訊，以及開啟/關閉指定的 EC2。要進行這些操作，我們需要賦予 Lambda function 權限，所以須建立 IAM Role。先新增所需的 Policy，JSON 設定請複製這裡：https://gist.github.com/LYTzeng/f935732d160c8fa72e90a18deeed9ae4 ，再將這個 Policy Attach 至新增的 Role。</p> <h3 id="建立-function"><a href="#建立-function" class="header-anchor">#</a> 建立 Function</h3> <p>到 Lambda 界面，選擇 <strong>Create Function</strong>，<strong>Runtime</strong> 選擇 <strong>Go 1.x</strong>，<strong>Permissions</strong> 選擇 <strong>Use an existing role</strong> 找到剛才建立的 Role 並套用。</p> <p>因為這次使用 Go 撰寫程式，必須先 compile 成能夠讓 Linux 執行的 binary (Lambda 底層 OS 使用 Amazon Linux) 並上傳，而且只能寫在 <code>package main</code> 裡面。你可以直接<a href="https://github.com/LYTzeng/ec2ctl/releases/download/0.1.0/main.zip" target="_blank" rel="noopener noreferrer">下載 compile 過的執行檔<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，透過 console 上傳 <strong>Function Package</strong>，<strong>Handler</strong> 設定為 <code>main.upx</code>。</p> <p>接著找到 <strong>Environment Variables</strong> 區塊新增環境變數，<strong>Key</strong> 請輸入 <code>MATTERMOST_TOKEN</code>，<strong>Value</strong> 為你的 Mattermost server 的 Slash command <strong>token</strong>。</p> <p>接著新增一個 <strong>Trigger</strong>：
<img alt="" data-src="https://i.imgur.com/VYJkazR.png" loading="lazy" class="lazy"></p> <p>選擇 <strong>API Gateway</strong>，<strong>API</strong> 就是剛才建立的 API，<strong>Deployment Stage</strong> 是剛才 Deploy 時命名的名稱 (如：<code>dev</code>)，<strong>Security</strong> 選 <strong>Open</strong>，我們已經用 Token 做驗證，加上用 Resource Policy 白名單過濾，不必擔心這個 Open 設定。
<img alt="" data-src="https://i.imgur.com/jheCEwG.png" loading="lazy" class="lazy"></p> <p>接著回到 <strong>API Gateway</strong> 頁面，選擇 <code>/ec2ctl</code> 底下的 <strong>POST</strong>，設定 <strong>Integration Request</strong></p> <ul><li><strong>Integration type</strong> 為 <strong>Lambda Function</strong></li> <li><strong>Use Lambda Proxy integration 務必勾選</strong>，此選項可透過 event 將 Request body 傳送至 Lambda。</li> <li><strong>Lambda Function</strong> 即剛才建立的 function
<img alt="" data-src="https://i.imgur.com/Js98mml.png" loading="lazy" class="lazy">
儲存後可以看到整個 Method Execution 流程。</li></ul> <p><img alt="" data-src="https://i.imgur.com/VinbrZD.png" loading="lazy" class="lazy"></p> <p>這樣系統已經建制完畢，接下來可以使用 Postman 進行測試，或是直接在 Mattermost 開發環境測試。</p> <h2 id="mattermost-架設與設定"><a href="#mattermost-架設與設定" class="header-anchor">#</a> Mattermost 架設與設定</h2> <p>本篇不會詳述這部份操作，請參考 Mattermost 的官方文件：</p> <ul><li>開發環境架設
https://developers.mattermost.com/contribute/server/developer-setup/</li> <li>Slash Command 設定
https://docs.mattermost.com/developer/slash-commands.html
https://developers.mattermost.com/integrate/slash-commands/
Slash Command 設定可以參考這裡的範例：</li></ul> <blockquote><ul><li>Title: <code>ec2ctl</code></li> <li>Description: <code>Start/stop/list EC2 instances from Mattermost.</code></li> <li>Command Trigger Word: <code>ec2ctl</code></li> <li>Request URL: <code>https://{restapi-id}.execute-api.{region}.amazonaws.com/dev/ec2ctl</code></li> <li>Request Method: <code>POST</code></li> <li>Response Username: <code>留空白</code></li> <li>Response Icon: <code>留空白</code></li> <li>Autocomplete: ✔</li> <li>Autocomplete Hint: <code>(version | (start | stop) -i &lt;instance id&gt; | ls [-r &lt;region&gt;])</code></li> <li>Autocomplete Description: <code>Start/stop/list EC2 instances from Mattermost.</code></li></ul></blockquote> <p>設定完畢請複製 <strong>token</strong> 並貼上至 Lambda 的 Environment Variable <code>MATTERMOST_TOKEN</code> 中。
<img alt="" data-src="https://docs.mattermost.com/_images/slash_commands_token.png" loading="lazy" class="lazy"></p> <h2 id="使用-mattermost-測試"><a href="#使用-mattermost-測試" class="header-anchor">#</a> 使用 Mattermost 測試</h2> <p>此程式 <a href="https://github.com/LYTzeng/ec2ctl" target="_blank" rel="noopener noreferrer">ec2ctl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的 Slash command 規則如下：</p> <div class="language- extra-class"><pre class="language-text"><code>Usage:
    ec2ctl version
    ec2ctl (stop | start) -i &lt;id&gt;
    ec2ctl ls [-r &lt;region&gt;]
Options:
    -i &lt;id&gt;    Specify an instance ID.
    -r &lt;region&gt;    Specify a region.
</code></pre></div><p>測試指令是否正常，<code>/ec2ctl ls -r us-west-2</code>輸入後可以看到輸出如下：
<img alt="" data-src="https://i.imgur.com/jaTBuco.png" loading="lazy" class="lazy"></p> <h2 id="使用-postman-測試"><a href="#使用-postman-測試" class="header-anchor">#</a> 使用 Postman 測試</h2> <p>使用 Postman 測試時需要模仿 Mattermost 的 HTTP Request 格式，否則程式會出錯。圖中 Postman 的設置都是必要的參數，不過只須設定 <strong>Headers</strong> 以及 <strong>Body</strong>：</p> <p><strong>Content-Type</strong>：<code>application/x-www-from-urlencoded</code> <img alt="" data-src="https://i.imgur.com/JhnYTU2.png" loading="lazy" class="lazy"></p> <p><strong>token</strong> 為 Mattermost slash command token
<strong>text</strong> 欄位就是指令的內容 （不含 slash command 的 trigger <code>/ec2ctl</code>），例如<code>ls -r us-west-2</code> 或 <code>stop -i i-134134fwifi</code>。
<strong>user_name</strong> 請隨意輸入
<img alt="" data-src="https://i.imgur.com/1l8ueF8.png" loading="lazy" class="lazy"></p> <p>若看到 <code>Status: 200 OK</code> 和一些內容，代表成功了。</p> <p><img alt="" data-src="https://i.imgur.com/c2t7NUi.png" loading="lazy" class="lazy"></p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies.html" target="_blank" rel="noopener noreferrer">IAM JSON Policy Reference <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-deploy-api.html" target="_blank" rel="noopener noreferrer">Deploying a REST API in Amazon API Gateway<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <!----> </main> <footer><div>
      Copyright © 2019-present Li Yen Tseng, Powered by <a href="http://vuepress.vuejs.org">VuePress</a></div></footer></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.734983b6.js" defer></script><script src="/assets/js/2.4abc6c77.js" defer></script><script src="/assets/js/3.24286270.js" defer></script><script src="/assets/js/9.2acc88bd.js" defer></script>
  </body>
</html>
