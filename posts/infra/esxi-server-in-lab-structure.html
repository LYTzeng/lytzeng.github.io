<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>實驗室自架 Lab 環境 — 網路架構設計 | Oscar&#39;s Pathways</title>
    <meta name="description" content="自前陣子學校電腦教室汰換之電腦，有幾台送給實驗室利用，我藉這個機會使用那些資源架設一台 ESXi。架設完成後，接下來考量到一些需求與環境因素，開始設計網路的架構。這篇會使用 pfSense、OpenVPN、ESXi 伺服器和一台 Cisco 2950 Switch，進行網路架構設計。">
    <link rel="icon" href="/logo.png">
  <meta name="theme-color" content="#333333">
  <meta prefix="og: http://ogp.me/ns#" property="og:title" content="Oscar&#39;s Pathways">
  <meta prefix="og: http://ogp.me/ns#" property="og:type" content="article">
  <meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://lytzeng.github.io">
  <meta prefix="og: http://ogp.me/ns#" property="og:image" content="/logo.png">
  <meta prefix="og: http://ogp.me/ns#" property="og:article:author" content="Li-Yen Tseng">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/logo.png">
  <link rel="mask-icon" href="/logo.svg" color="#333333">
  <meta name="msapplication-TileColor" content="#333333">
  <meta name="google-site-verification" content="luVocIl3165-z3eRtc2ux4f0_QqyqMiauRI-fD0GoJ0">
    
    <link rel="preload" href="/assets/css/0.styles.e2fb14d1.css" as="style"><link rel="preload" href="/assets/js/app.39627a89.js" as="script"><link rel="preload" href="/assets/js/3.56656fbc.js" as="script"><link rel="preload" href="/assets/js/2.c4dd9767.js" as="script"><link rel="preload" href="/assets/js/4.e4b8313d.js" as="script"><link rel="preload" href="/assets/js/13.b3ed8631.js" as="script"><link rel="prefetch" href="/assets/js/10.6e274530.js"><link rel="prefetch" href="/assets/js/11.5342fc6b.js"><link rel="prefetch" href="/assets/js/12.0de21cab.js"><link rel="prefetch" href="/assets/js/14.e90c434b.js"><link rel="prefetch" href="/assets/js/15.c022dbc1.js"><link rel="prefetch" href="/assets/js/16.0a9c76e7.js"><link rel="prefetch" href="/assets/js/17.d24a09d2.js"><link rel="prefetch" href="/assets/js/18.31f10395.js"><link rel="prefetch" href="/assets/js/19.6b6a6026.js"><link rel="prefetch" href="/assets/js/20.a001f940.js"><link rel="prefetch" href="/assets/js/21.f2ed67b1.js"><link rel="prefetch" href="/assets/js/22.ed63aa88.js"><link rel="prefetch" href="/assets/js/5.bf60b092.js"><link rel="prefetch" href="/assets/js/6.4e96e2c5.js"><link rel="prefetch" href="/assets/js/7.26f0178e.js"><link rel="prefetch" href="/assets/js/8.cc482854.js"><link rel="prefetch" href="/assets/js/9.775ca00a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2fb14d1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="Oscar's Pathways" class="logo"> <span class="site-name can-hide">Oscar's Pathways</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/categories/" class="nav-link">Categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><div class="bio bio-sidebar"><div class="img-holder"><img src="https://avatars3.githubusercontent.com/u/30722178?s=460&v=4"></div> <p class="name">Oscar Tseng</p> <div style="border-bottom: 1px solid hsl(0, 0%, 30%); border-top: 1px solid hsl(0, 0%, 30%);"><div style="display: inline-block; padding: 0 10px; border-right: 1px solid hsl(0, 0%, 30%); margin: 5px 0"><a href="/categories/"><span style="display:block;font-family:'Noto Sans TC Medium';font-size:20px;">6</span> <span>Posts</span></a></div> <div style="display: inline-block; padding: 0 10px; margin: 5px 0"><a href="/tags/"><span style="display:block;font-family:'Noto Sans TC Medium';font-size:20px;">6</span> <span>Tags</span></a></div></div> <div style="display: flex; justify-content: center; padding-top: 5px; padding-bottom: 5px; border-bottom: 1px solid hsl(0, 0%, 30%);"><span style="width: 32px; height: 32px;"><a href="https://github.com/LYTzeng" target="_blank" rel="noopener" title="Github"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path fill-rule="evenodd" d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45 3 3 0 0 0 4.08 1.16 2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76 5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7 5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z"></path></svg></a></span> <span style="width: 32px; height: 32px;"><a href="https://www.linkedin.com/in/li-yen-tseng/" target="_blank" rel="noopener" title="Linkedin"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path d="M26.21 4H5.79A1.78 1.78 0 0 0 4 5.73V26.2a1.77 1.77 0 0 0 1.79 1.73h20.42A1.77 1.77 0 0 0 28 26.2V5.73A1.78 1.78 0 0 0 26.21 4zm-15.1 20.41H7.59V13h3.52zm-1.72-13a2.07 2.07 0 0 1-2.07-2.02 2 2 0 0 1 2.07-2.07 2.07 2.07 0 0 1 0 4.13zm15.09 12.93H21v-5.58c0-1.33 0-3.06-1.86-3.06S17 17.16 17 18.63v5.65h-3.56V13h3.32v1.5h.07a3.72 3.72 0 0 1 3.39-1.86c3.59 0 4.26 2.4 4.26 5.45z"></path></svg></a></span> <span style="width: 32px; height: 32px;"><a href="mailto:oscar217b@gmail.com" target="_blank" rel="noopener" title="mail"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path d="M28 6H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2zm-2.2 2L16 14.78 6.2 8zM4 24V8.91l11.43 7.91a1 1 0 0 0 1.14 0L28 8.91V24z"></path><title>Email</title></svg></a></span> <span style="width: 32px; height: 32px;"><a href="/feed.xml" target="_blank" rel="noopener" title="rss" type="application/rss+xml"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path d="M8 18c-3.3 0-6 2.7-6 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6zm0 10c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4zm22-4h-2C28 13 19 4 8 4V2c12.1 0 22 9.9 22 22z"></path><path d="M22 24h-2c0-6.6-5.4-12-12-12v-2c7.7 0 14 6.3 14 14z"></path><title>Rss</title></svg></a></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/categories/" class="nav-link">Categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>實驗室自架 Lab 環境 — 網路架構設計</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/infra/esxi-server-in-lab-structure.html#需求與現有環境" class="sidebar-link">需求與現有環境</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/infra/esxi-server-in-lab-structure.html#架構圖" class="sidebar-link">架構圖</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/infra/esxi-server-in-lab-structure.html#cisco-switch-設定" class="sidebar-link">Cisco Switch 設定</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/infra/esxi-server-in-lab-structure.html#安裝-pfsense" class="sidebar-link">安裝 pfSense</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/infra/esxi-server-in-lab-structure.html#vsphere-網路設定" class="sidebar-link">vSphere 網路設定</a></li><li class="sidebar-sub-header"><a href="/posts/infra/esxi-server-in-lab-structure.html#建立連接埠群組" class="sidebar-link">建立連接埠群組</a></li><li class="sidebar-sub-header"><a href="/posts/infra/esxi-server-in-lab-structure.html#建立-pfsense-vm" class="sidebar-link">建立 pfSense VM</a></li></ul></li><li><a href="/posts/infra/esxi-server-in-lab-structure.html#設定-openvpn" class="sidebar-link">設定 OpenVPN</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/infra/esxi-server-in-lab-structure.html#新增-ca-憑證" class="sidebar-link">新增 CA 憑證</a></li><li class="sidebar-sub-header"><a href="/posts/infra/esxi-server-in-lab-structure.html#新增-server-憑證" class="sidebar-link">新增 Server 憑證</a></li><li class="sidebar-sub-header"><a href="/posts/infra/esxi-server-in-lab-structure.html#openvpn-server-設定" class="sidebar-link">OpenVPN Server 設定</a></li><li class="sidebar-sub-header"><a href="/posts/infra/esxi-server-in-lab-structure.html#firewall-rules" class="sidebar-link">Firewall Rules</a></li><li class="sidebar-sub-header"><a href="/posts/infra/esxi-server-in-lab-structure.html#新增-user" class="sidebar-link">新增 User</a></li><li class="sidebar-sub-header"><a href="/posts/infra/esxi-server-in-lab-structure.html#openvpn-client-export-package" class="sidebar-link">OpenVPN Client Export Package</a></li></ul></li><li><a href="/posts/infra/esxi-server-in-lab-structure.html#結語" class="sidebar-link">結語</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> <div class="sidebar-links"><p class="sidebar-heading"><span>近期文章</span></p> <ul><li><a href="/posts/infra/esxi-server-in-lab-structure.html" class="sidebar-link recentTitle">實驗室自架 Lab 環境 — 網路架構設計</a></li><li><a href="/posts/infra/self-hosted-esxi-server-in-lab.html" class="sidebar-link recentTitle">在實驗室自架 VMware ESXi — 使用電腦教室汰換之電腦</a></li><li><a href="/posts/frontend/Vue/vuepress-blog-3.html" class="sidebar-link recentTitle">VuePress 部落格架設與折騰 (三)：Global Computed、標籤與分類功能、Components 的應用</a></li><li><a href="/posts/frontend/Vue/vuepress-blog-2.html" class="sidebar-link recentTitle">VuePress 部落格架設與折騰 (二)：Components</a></li><li><a href="/posts/frontend/Vue/vuepress-blog-1.html" class="sidebar-link recentTitle">VuePress 部落格架設與折騰 (一)：Themes、頁面元素、部署至 Github</a></li><li><a href="/posts/misc/Why-I-launch-this-blog.html" class="sidebar-link recentTitle">開端</a></li></ul></div> <div class="sidebar-links"><p class="sidebar-heading"><span>Tags</span></p> <div class="tags sidebar-tags sidebar-link"><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/VMware"><div>VMware
        <div class="tagcount">2</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/vSphere"><div>vSphere
        <div class="tagcount">2</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/pfSense"><div>pfSense
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/OpenVPN"><div>OpenVPN
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/VuePress"><div>VuePress
        <div class="tagcount">3</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/心得想法"><div>心得想法
        <div class="tagcount">1</div></div></a></span></span></div></div> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="實驗室自架-lab-環境-—-網路架構設計"><a href="#實驗室自架-lab-環境-—-網路架構設計" class="header-anchor">#</a> 實驗室自架 Lab 環境 — 網路架構設計</h1> <div class="page-edit"><div class="last-updated"><span class="prefix"><svg fill="#ececec" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true" style="display: inline-block; vertical-align: middle; will-change: transform;"><path d="M26 4.03h-4v-2h-2v2h-8v-2h-2v2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h20a2 2 0 0 0 2-2v-20a2 2 0 0 0-2-2zm0 22H6v-14h20zm0-16H6v-4h4v2h2v-2h8v2h2v-2h4z"></path><title>Calendar</title></svg></span> <span class="time">12/18/2019, 4:34:14 PM</span></div></div> <div><div class="taglinks"><a href="/categories/#Infra"><div style="display:inline;"><svg fill="#14cdef" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true" style="display:inline-block;vertical-align:middle;will-change:transform;"><path d="M11.17 6l3.42 3.41.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z"></path><title>Folder</title></svg></div>
  Infra</a> <a href="/tags/VMware"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>VMware</span></a><a href="/tags/vSphere"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>vSphere</span></a><a href="/tags/pfSense"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>pfSense</span></a><a href="/tags/OpenVPN"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>OpenVPN</span></a></div></div> <p><img src="https://i.imgur.com/UhT17Yp.png" alt=""></p> <p>前陣子學校電腦教室汰換之電腦，有幾台送給實驗室利用，我藉這個機會使用那些資源<a href="/posts/infra/self-hosted-esxi-server-in-lab.html">架設一台 ESXi</a>。架設完成後，接下來考量到一些需求與環境因素，開始設計網路的架構。這篇會使用 <a href="https://www.pfsense.org/" target="_blank" rel="noopener noreferrer">pfSense<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、OpenVPN、ESXi 伺服器和一台 Cisco 2950 Switch，進行網路架構設計。</p> <h2 id="需求與現有環境"><a href="#需求與現有環境" class="header-anchor">#</a> 需求與現有環境</h2> <p>對於 Lab 環境的幾項需求，分別如下：</p> <ol><li>所有 VM 皆可連接外網，因為如 <a href="https://www.eve-ng.net/" target="_blank" rel="noopener noreferrer">EVE-NG<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 在安裝時便需要連接外部下載 Package</li> <li>對於 VM 的 DHCP，如果伺服器提供讓一些同學使用，在上面佈建的 VM 有 DHCP 較方便</li> <li>能夠從校內與校外網路 VPN 進入 Lab 環境</li> <li><mark>不能</mark>直接從 WAN 連到 ESXi 的管理介面</li> <li>可以透過 VPN 間接連到管理介面</li> <li>如果使用實驗室裡面的電腦存取伺服器，無須繞過學校的網段，可透過自己的 LAN 直連</li> <li>必要的話始可使用 Port Forwarding</li></ol> <p>現有環境有一些限制，不過不成問題：</p> <ol><li>學校的網管系統，綁定學校 Public IP 與 MAC</li> <li>要進行遠端，只能使用 RDP，Team Viewer 與 Google Remote Desktop 皆會被擋</li></ol> <h2 id="架構圖"><a href="#架構圖" class="header-anchor">#</a> 架構圖</h2> <p>規劃時，我畫了一張架構圖，方便日後管理與交接。</p> <p><img src="https://i.imgur.com/ZJ8IsOX.png" alt=""></p> <p>由於 Server 的主機板原本就帶有兩個網路介面，因此可以使用 pfSense，將一個 NIC 作為 WAN，另一個做為 LAN。pfSense 在架構中擔任 Firewall 與 Router 的腳色，提供包含 NAT、Routing、VPN 和 DHCP Sever的功能。因為我只跟學校要到一個 IP，不想買一台 Firewall，所以 pfSense 就是首選。</p> <h2 id="cisco-switch-設定"><a href="#cisco-switch-設定" class="header-anchor">#</a> Cisco Switch 設定</h2> <p>Switch 的設定非常簡單，我透過 VLAN 拆分成邏輯上的兩台不同的交換器，一個負責 LAN，同時是交換器的管理 VLAN;另一個連接學網對外(Uplink)與 Server 規劃的 WAN 端。</p> <div class="language- extra-class"><pre class="language-text"><code># int ra fa 0/1 - 12
(config-if)# sw mode access
(config-if)# sw access vl 10
# int ra fa 0/13 - 24
(config-if)# sw mode access
</code></pre></div><p>但是第24 port 要接到學校的 Swich，我怕對端有設定<a href="https://www.cisco.com/c/en/us/support/docs/lan-switching/spanning-tree-protocol/10586-65.html" target="_blank" rel="noopener noreferrer">BPDU Guard<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，因此特定對該port開啟 <strong>BPDU filter</strong>，阻止我的交換器發出 BPDU。</p> <div class="language- extra-class"><pre class="language-text"><code># int fa0/24
(config-if)# spanning-tree bpdufilter en
</code></pre></div><p>同時將 VTP 的模式切換成 Transparent，總之，避免一切私接 Switch 對學校網路的影響。</p> <div class="language- extra-class"><pre class="language-text"><code># vtp mode transparent
</code></pre></div><h2 id="安裝-pfsense"><a href="#安裝-pfsense" class="header-anchor">#</a> 安裝 pfSense</h2> <p>安裝 pfSense 的過程參考自<a href="https://docs.netgate.com/pfsense/en/latest/virtualization/virtualizing-pfsense-with-vmware-vsphere-esxi.html" target="_blank" rel="noopener noreferrer">官方文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，這邊順便翻譯以內化學習。</p> <h3 id="vsphere-網路設定"><a href="#vsphere-網路設定" class="header-anchor">#</a> vSphere 網路設定</h3> <p>在建立 VM 前，需要在 ESXi 上新增2個 vSwitch 和兩個連接埠群組(Port Group)，一個做為 WAN，另一個作為 LAN。</p> <p>在左側選擇「網路」，切換至「虛擬交換器」標籤，「新增虛擬交換器」。
<img src="https://i.imgur.com/i0F9jVg.png" alt=""></p> <p>圖中是把 vSwitch0 作為 LAN，兩個 vSwitch 分別連接到不同的實體介面。
<img src="https://i.imgur.com/3Ss6AYf.png" alt=""></p> <h3 id="建立連接埠群組"><a href="#建立連接埠群組" class="header-anchor">#</a> 建立連接埠群組</h3> <p>切換到「連接埠群組」標籤，新增兩個群組，分別連接到 LAN 和 WAN 兩個 vSwitch。
<img src="https://i.imgur.com/ZkamIQ0.png" alt=""></p> <h3 id="建立-pfsense-vm"><a href="#建立-pfsense-vm" class="header-anchor">#</a> 建立 pfSense VM</h3> <p>到<a href="https://www.pfsense.org/download/" target="_blank" rel="noopener noreferrer">這裡<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>下載映像檔，64位元系統請選「AMD64」，下面選「CD Image (ISO) Installer」。其餘步驟和一般架設 VM 是一樣的。注意 VM 的網卡，種類選 <strong>VMXNET 3</strong> 的效能最好，但是第一次啟動時要手動選擇 LAN/WAN 介面。</p> <p>接著開啟 VM，看到以下畫面
<img src="https://i.imgur.com/QPqVEb0.png" alt=""></p> <p>當看到下面畫面時，可以先輸入 2 設定 IP 了。
<img src="https://i.imgur.com/HOQa7G1.png" alt=""></p> <p>接著連入 pfSense 的 Web UI，預設登入帳密是 <code>admin</code>，密碼<code>pfsense</code>，安全考量，請一定要更改預設密碼。接著就可以安裝 VMware tools。</p> <p>不過我的環境是學網，DNS 必須使用學校所規定的，能夠成功解析地址才能讓 Package Manager 連得上。</p> <p><img src="https://i.imgur.com/BIj7Tp8.png" alt=""></p> <p>安裝 VMware tools。切換到 Available Packages 標籤，搜尋 Open-vm-tools
<img src="https://i.imgur.com/Ce7ASRq.png" alt=""></p> <h2 id="設定-openvpn"><a href="#設定-openvpn" class="header-anchor">#</a> 設定 OpenVPN</h2> <p>這裡一樣是翻譯自<a href="https://docs.netgate.com/pfsense/en/latest/vpn/openvpn/openvpn-remote-access-server.html" target="_blank" rel="noopener noreferrer">文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>這邊使用的是「最基本」的設定，使用 local user 的帳密進行驗證。pfSense 的 <strong>VPN &gt; OpenVPN</strong> 底下，有 <strong>Wizard</strong> 的選項，是比較簡易設置 VPN 的方式。第一步選擇 <strong>Local User Access</strong>，User 可以到 <strong>System &gt; User Manager</strong> 新增。</p> <h3 id="新增-ca-憑證"><a href="#新增-ca-憑證" class="header-anchor">#</a> 新增 CA 憑證</h3> <p>接著新增一個自簽憑證，設定可以參考下面
<img src="https://i.imgur.com/NjQnhtu.png" alt=""></p> <h3 id="新增-server-憑證"><a href="#新增-server-憑證" class="header-anchor">#</a> 新增 Server 憑證</h3> <p>資料和 CA 的類似
<img src="https://i.imgur.com/WISRLsL.png" alt=""></p> <h3 id="openvpn-server-設定"><a href="#openvpn-server-設定" class="header-anchor">#</a> OpenVPN Server 設定</h3> <ul><li><strong>TLS Authentication</strong> 請打勾</li> <li><strong>Tunnel Network</strong> 請輸入一個網段，該網段不能存在於現有網路和路由表中。</li> <li><strong>Local Network</strong> 就是 VPN 進來後可以存取的網段，依照上面的架構圖就是 <code>172.30.0.0/24</code>。</li></ul> <p>接著下一步。</p> <h3 id="firewall-rules"><a href="#firewall-rules" class="header-anchor">#</a> Firewall Rules</h3> <p>底下兩個選項都打勾，否則不會通。</p> <p>接著設定便完成了。到 <strong>Firewall &gt; rules</strong> 確認防火牆規則有沒有新增一條規則：Source any 到 destination WAN，port 則是剛才設定中的 OpneVPN port，預設是<code>1194</code>。</p> <p><img src="https://i.imgur.com/GhKawlB.png" alt=""></p> <h3 id="新增-user"><a href="#新增-user" class="header-anchor">#</a> 新增 User</h3> <p><strong>System &gt; User Manager</strong> 底下，選+號新增 user ，CA 請選擇剛才建立的。</p> <h3 id="openvpn-client-export-package"><a href="#openvpn-client-export-package" class="header-anchor">#</a> OpenVPN Client Export Package</h3> <p>這個工具非常好用，它可以針對特定使用者，輸出一個安裝檔(帶有使用者和這個VPN的相關設定)，所以使用者只要安裝完即可使用。</p> <p>到 <strong>System &gt; Packages, Available Packages</strong> 標籤，搜尋 openvpn，安裝 <strong>OpenVPN Client Export Package</strong>。</p> <p><img src="https://i.imgur.com/Uk82ibO.png" alt=""></p> <p>接著到 <strong>VPN &gt; OpenVPN, Client Export</strong>標籤底下，會發現剛才建立的使用者。</p> <p><img src="https://i.imgur.com/TuQJciw.png" alt=""></p> <p>如果是 Windows，下載<strong>Current Windows Installer</strong>底下的選項，給 User 安裝即可。<mark>千萬不要</mark>單獨下載設定檔，另外安裝 OpenVPN Client 然後輸入設定，我嘗試過這樣
會失敗。盡量使用 Installer。</p> <h2 id="結語"><a href="#結語" class="header-anchor">#</a> 結語</h2> <p>目前完成了 Lab 的架構，所有網路需求也達成了。我可以從任何地方 VPN 到我的 LAN，登入 ESXi 介面，甚至可以對實體的 Cisco Switch 進行設定。如果需要上傳龐大的 Image，我可以遠端到我的 Lab PC，作為跳板機，從該 PC 透過 LAN 上傳檔案至 Server 而不會消耗 WAN 流量。而日後任何新的 VM 被建立，也都可以自動取得 IP 和指定的 DNS resolver，已達成更新與安裝 Packages。</p> <div id="disqus_thread"></div></div> <!----> </main> <footer><div>
      Copyright © 2019-present Li Yen Tseng, Powered by <a href="http://vuepress.vuejs.org">VuePress</a></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.39627a89.js" defer></script><script src="/assets/js/3.56656fbc.js" defer></script><script src="/assets/js/2.c4dd9767.js" defer></script><script src="/assets/js/4.e4b8313d.js" defer></script><script src="/assets/js/13.b3ed8631.js" defer></script>
  </body>
</html>
