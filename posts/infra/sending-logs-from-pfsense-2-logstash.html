<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ELK Stack 整合 pfSense (一)：將 pfSense 防火牆阻擋紀錄傳送到 Logstash | Oscar&#39;s Pathways</title>
    <meta name="description" content="Logstash 的功能像是一個接收器，支援從許多種 Protocol 接收 Log，如 Syslog、Netflow等，並且透過 Parser 將非結構化資料轉換成半結構化資料。Parser 方便的是使用 Grok Pattern，可以避免自行撰寫複雜的 Regex，不過他也支援 Regex 讓我們可以自訂 Pattern，因此 logstash 的 parsing 是很彈性的。本系列文章介紹 pfSense 與 ELK Stack (7.6 版) 的整合，藉此分析與收集阻擋的連接紀錄。">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/logo.png">
  <meta name="theme-color" content="#333333">
  <meta prefix="og: http://ogp.me/ns#" property="og:title" content="Oscar&#39;s Pathways">
  <meta prefix="og: http://ogp.me/ns#" property="og:type" content="article">
  <meta prefix="og: http://ogp.me/ns#" property="og:url" content="http://lytzeng.github.io">
  <meta prefix="og: http://ogp.me/ns#" property="og:image" content="/logo.png">
  <meta prefix="og: http://ogp.me/ns#" property="og:article:author" content="Li-Yen Tseng">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/logo.png">
  <link rel="mask-icon" href="/logo.svg" color="#333333">
  <meta name="msapplication-TileColor" content="#333333">
  <meta name="google-site-verification" content="luVocIl3165-z3eRtc2ux4f0_QqyqMiauRI-fD0GoJ0">
  <link rel="alternate" type="application/rss+xml" href="http://lytzeng.github.io/rss.xml" title="Oscar&#39;s Pathways RSS Feed">
  <link rel="alternate" type="application/atom+xml" href="http://lytzeng.github.io/feed.atom" title="Oscar&#39;s Pathways Atom Feed">
  <link rel="alternate" type="application/json" href="http://lytzeng.github.io/feed.json" title="Oscar&#39;s Pathways JSON Feed"><link rel='canonical' href='http://lytzeng.github.io/posts/infra/sending-logs-from-pfsense-2-logstash.html'/>
    <meta name="image" content="http://lytzeng.github.io/images/infra/sending-logs-from-pfsense-2-logstash.png"><meta name="twitter:title" content="ELK Stack 整合 pfSense (一)：將 pfSense 防火牆阻擋紀錄傳送到 Logstash"><meta name="twitter:description" content="Logstash 的功能像是一個接收器，支援從許多種 Protocol 接收 Log，如 Syslog、Netflow等，並且透過 Parser 將非結構化資料轉換成半結構化資料。Parser 方便的是使用 Grok Pattern，可以避免自行撰寫複雜的 Regex，不過他也支援 Regex 讓我們可以自訂 Pattern，因此 logstash 的 parsing 是很彈性的。本系列文章介紹 pfSense 與 ELK Stack (7.6 版) 的整合，藉此分析與收集阻擋的連接紀錄。"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://lytzeng.github.io/images/infra/sending-logs-from-pfsense-2-logstash.png"><meta name="twitter:url" content="http://lytzeng.github.io/posts/infra/sending-logs-from-pfsense-2-logstash.html"><meta property="og:type" content="article"><meta property="og:title" content="ELK Stack 整合 pfSense (一)：將 pfSense 防火牆阻擋紀錄傳送到 Logstash"><meta property="og:description" content="Logstash 的功能像是一個接收器，支援從許多種 Protocol 接收 Log，如 Syslog、Netflow等，並且透過 Parser 將非結構化資料轉換成半結構化資料。Parser 方便的是使用 Grok Pattern，可以避免自行撰寫複雜的 Regex，不過他也支援 Regex 讓我們可以自訂 Pattern，因此 logstash 的 parsing 是很彈性的。本系列文章介紹 pfSense 與 ELK Stack (7.6 版) 的整合，藉此分析與收集阻擋的連接紀錄。"><meta property="og:image" content="http://lytzeng.github.io/images/infra/sending-logs-from-pfsense-2-logstash.png"><meta property="og:url" content="http://lytzeng.github.io/posts/infra/sending-logs-from-pfsense-2-logstash.html"><meta property="article:tag" content="ELK"><meta property="article:tag" content="pfSense"><meta itemprop="name" content="ELK Stack 整合 pfSense (一)：將 pfSense 防火牆阻擋紀錄傳送到 Logstash"><meta itemprop="description" content="Logstash 的功能像是一個接收器，支援從許多種 Protocol 接收 Log，如 Syslog、Netflow等，並且透過 Parser 將非結構化資料轉換成半結構化資料。Parser 方便的是使用 Grok Pattern，可以避免自行撰寫複雜的 Regex，不過他也支援 Regex 讓我們可以自訂 Pattern，因此 logstash 的 parsing 是很彈性的。本系列文章介紹 pfSense 與 ELK Stack (7.6 版) 的整合，藉此分析與收集阻擋的連接紀錄。"><meta itemprop="image" content="http://lytzeng.github.io/images/infra/sending-logs-from-pfsense-2-logstash.png">
    <link rel="preload" href="/assets/css/0.styles.979d2b17.css" as="style"><link rel="preload" href="/assets/js/app.d9dd9f6f.js" as="script"><link rel="preload" href="/assets/js/2.91151622.js" as="script"><link rel="preload" href="/assets/js/3.65100333.js" as="script"><link rel="preload" href="/assets/js/16.564ab575.js" as="script"><link rel="prefetch" href="/assets/js/10.c77e1705.js"><link rel="prefetch" href="/assets/js/11.b9553755.js"><link rel="prefetch" href="/assets/js/12.b83c5a8d.js"><link rel="prefetch" href="/assets/js/13.8ab282c4.js"><link rel="prefetch" href="/assets/js/14.bf8a5d66.js"><link rel="prefetch" href="/assets/js/15.c5fbc382.js"><link rel="prefetch" href="/assets/js/17.9dbccc8b.js"><link rel="prefetch" href="/assets/js/18.6755ab7b.js"><link rel="prefetch" href="/assets/js/19.56e486c4.js"><link rel="prefetch" href="/assets/js/20.2ac42cc2.js"><link rel="prefetch" href="/assets/js/21.9501ad5f.js"><link rel="prefetch" href="/assets/js/22.c8a3f5ef.js"><link rel="prefetch" href="/assets/js/23.f385ff61.js"><link rel="prefetch" href="/assets/js/24.91e38b15.js"><link rel="prefetch" href="/assets/js/25.df9dd762.js"><link rel="prefetch" href="/assets/js/26.97dc7c01.js"><link rel="prefetch" href="/assets/js/27.f6952119.js"><link rel="prefetch" href="/assets/js/28.bfcba898.js"><link rel="prefetch" href="/assets/js/29.b6049aae.js"><link rel="prefetch" href="/assets/js/30.9cbda11c.js"><link rel="prefetch" href="/assets/js/31.d53a8329.js"><link rel="prefetch" href="/assets/js/32.085bbc5d.js"><link rel="prefetch" href="/assets/js/33.b89cf343.js"><link rel="prefetch" href="/assets/js/4.e5ef27f9.js"><link rel="prefetch" href="/assets/js/5.d110cd42.js"><link rel="prefetch" href="/assets/js/6.b43dc1af.js"><link rel="prefetch" href="/assets/js/7.3bd41f35.js"><link rel="prefetch" href="/assets/js/8.b916c535.js"><link rel="prefetch" href="/assets/js/9.07a13ebc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.979d2b17.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="Oscar's Pathways" class="logo"> <span class="site-name can-hide">Oscar's Pathways</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/categories/" class="nav-link">Categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><div class="bio bio-sidebar"><div class="img-holder"><img src="/bio.jpg"></div> <p class="name">Oscar Tseng</p> <div style="border-bottom: 1px solid hsl(0, 0%, 30%); border-top: 1px solid hsl(0, 0%, 30%);"><div style="display: inline-block; padding: 0 10px; border-right: 1px solid hsl(0, 0%, 30%); margin: 5px 0"><a href="/categories/"><span style="display:block;font-family:'Noto Sans TC Medium';font-size:20px;">12</span> <span>Posts</span></a></div> <div style="display: inline-block; padding: 0 10px; margin: 5px 0"><a href="/tags/"><span style="display:block;font-family:'Noto Sans TC Medium';font-size:20px;">12</span> <span>Tags</span></a></div></div> <div style="display: flex; justify-content: center; padding-top: 5px; padding-bottom: 5px; border-bottom: 1px solid hsl(0, 0%, 30%);"><span style="width: 32px; height: 32px;"><a href="https://github.com/LYTzeng" target="_blank" rel="noopener" title="Github"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path fill-rule="evenodd" d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45 3 3 0 0 0 4.08 1.16 2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76 5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7 5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z"></path></svg></a></span> <span style="width: 32px; height: 32px;"><a href="https://www.linkedin.com/in/li-yen-tseng/" target="_blank" rel="noopener" title="Linkedin"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path d="M26.21 4H5.79A1.78 1.78 0 0 0 4 5.73V26.2a1.77 1.77 0 0 0 1.79 1.73h20.42A1.77 1.77 0 0 0 28 26.2V5.73A1.78 1.78 0 0 0 26.21 4zm-15.1 20.41H7.59V13h3.52zm-1.72-13a2.07 2.07 0 0 1-2.07-2.02 2 2 0 0 1 2.07-2.07 2.07 2.07 0 0 1 0 4.13zm15.09 12.93H21v-5.58c0-1.33 0-3.06-1.86-3.06S17 17.16 17 18.63v5.65h-3.56V13h3.32v1.5h.07a3.72 3.72 0 0 1 3.39-1.86c3.59 0 4.26 2.4 4.26 5.45z"></path></svg></a></span> <span style="width: 32px; height: 32px;"><a href="mailto:oscar217b@gmail.com" target="_blank" rel="noopener" title="mail"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path d="M28 6H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2zm-2.2 2L16 14.78 6.2 8zM4 24V8.91l11.43 7.91a1 1 0 0 0 1.14 0L28 8.91V24z"></path><title>Email</title></svg></a></span> <span style="width: 32px; height: 32px;"><a href="/rss.xml" target="_blank" rel="noopener" title="rss" type="application/rss+xml"><svg fill="#e6e6e6" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true" style="will-change: transform;"><path d="M8 18c-3.3 0-6 2.7-6 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6zm0 10c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4zm22-4h-2C28 13 19 4 8 4V2c12.1 0 22 9.9 22 22z"></path><path d="M22 24h-2c0-6.6-5.4-12-12-12v-2c7.7 0 14 6.3 14 14z"></path><title>Rss</title></svg></a></span> <span style="width: 32px; height: 32px;"><a href="https://netlab.csie.ntut.edu.tw" target="_blank" rel="noopener" title="NTUT CSIE Netlab" type="application/rss+xml"><img src="/Netlab-new-icon-darktheme.svg" style="width: 32px; height: 32px;"></a></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/categories/" class="nav-link">Categories</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ELK Stack 整合 pfSense (一)：將 pfSense 防火牆阻擋紀錄傳送到 Logstash</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#elk-stack-整合-pfsense-系列文" class="sidebar-link">ELK Stack 整合 pfSense 系列文</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#安裝-logstash" class="sidebar-link">安裝 Logstash</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#logstash-的檔案結構" class="sidebar-link">Logstash 的檔案結構</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#pipeline-yml" class="sidebar-link">pipeline.yml</a></li><li class="sidebar-sub-header"><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#logstash-yml" class="sidebar-link">logstash.yml</a></li><li class="sidebar-sub-header"><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#config-file" class="sidebar-link">Config File</a></li><li class="sidebar-sub-header"><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#bin-檔" class="sidebar-link">bin 檔</a></li><li class="sidebar-sub-header"><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#custom-grok-patterns" class="sidebar-link">Custom Grok Patterns</a></li></ul></li><li><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#在-pfsense-設定-syslog-的-remote-log-server" class="sidebar-link">在 pfSense 設定 Syslog 的 Remote log server</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#建立-config-file-和-grok-patttern" class="sidebar-link">建立 Config file 和 Grok Patttern</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html#references" class="sidebar-link">References</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> <div class="sidebar-links"><p class="sidebar-heading"><span>近期文章</span></p> <ul><li><a href="/posts/infra/monitoring-pfsense-via-kibana.html" class="sidebar-link recentTitle">ELK Stack 整合 pfSense (三)：Kibana Dashboard</a></li><li><a href="/posts/infra/elasticsearch-receives-data-from-logstash.html" class="sidebar-link recentTitle">ELK Stack 整合 pfSense (二)：Elasticsearch</a></li><li><a href="/posts/infra/sending-logs-from-pfsense-2-logstash.html" class="sidebar-link recentTitle">ELK Stack 整合 pfSense (一)：將 pfSense 防火牆阻擋紀錄傳送到 Logstash</a></li><li><a href="/posts/misc/Installing-macOS-on-ESXi.html" class="sidebar-link recentTitle">想擁有一台伺服器等級 Mac? macOS 10.15 Catalina on VMware ESXi 6.7</a></li><li><a href="/posts/sdn/introduction-to-ryu.html" class="sidebar-link recentTitle">OpenFlow 1.5 從入門到交報告 (二) - Ryu</a></li></ul></div> <div class="sidebar-links"><p class="sidebar-heading"><span>Tags</span></p> <div class="tags sidebar-tags sidebar-link"><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/VuePress"><div>VuePress
        <div class="tagcount">3</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/ELK"><div>ELK
        <div class="tagcount">3</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/pfSense"><div>pfSense
        <div class="tagcount">4</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/VMware"><div>VMware
        <div class="tagcount">3</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/vSphere"><div>vSphere
        <div class="tagcount">3</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/OpenVPN"><div>OpenVPN
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/MacOS"><div>MacOS
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/心得想法"><div>心得想法
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/Mininet"><div>Mininet
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/OpenFlow"><div>OpenFlow
        <div class="tagcount">2</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/Ryu"><div>Ryu
        <div class="tagcount">1</div></div></a></span></span><span><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1><a href="/tags/Python"><div>Python
        <div class="tagcount">1</div></div></a></span></span></div></div> </aside> <main class="page"> <div class="theme-default-content content__default"><p><img alt="" data-src="/images/infra/sending-logs-from-pfsense-2-logstash.png" loading="lazy" class="lazy"></p> <h1 id="elk-stack-整合-pfsense-一-：將-pfsense-防火牆阻擋紀錄傳送到-logstash"><a href="#elk-stack-整合-pfsense-一-：將-pfsense-防火牆阻擋紀錄傳送到-logstash" class="header-anchor">#</a> ELK Stack 整合 pfSense (一)：將 pfSense 防火牆阻擋紀錄傳送到 Logstash</h1> <div class="page-edit"><div title="最後更新" class="timestamp"><span class="prefix"><svg fill="#ececec" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true" style="display: inline-block; vertical-align: middle; will-change: transform;"><path d="M2 27H30V29H2zM25.41 9a2 2 0 0 0 0-2.83L21.83 2.59a2 2 0 0 0-2.83 0l-15 15V24h6.41zm-5-5L24 7.59l-3 3L17.41 7zM6 22V18.41l10-10L19.59 12l-10 10z"></path><title>Calendar</title></svg></span> <span class="time">3/14/2020, 12:07:47 PM</span></div> <div title="建立時間" class="timestamp"><span class="prefix"><svg fill="#ececec" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true" style="display: inline-block; vertical-align: middle; will-change: transform;"><path d="M26 4.03h-4v-2h-2v2h-8v-2h-2v2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h20a2 2 0 0 0 2-2v-20a2 2 0 0 0-2-2zm0 22H6v-14h20zm0-16H6v-4h4v2h2v-2h8v2h2v-2h4z"></path><title>Calendar</title></svg></span> <span class="time">3/13/2020, 8:27:24 AM</span></div></div> <div><div class="taglinks"><a href="/categories/#Infra"><div style="display:inline;"><svg fill="#14cdef" focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true" style="display:inline-block;vertical-align:middle;will-change:transform;"><path d="M11.17 6l3.42 3.41.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z"></path><title>Folder</title></svg></div>
  Infra</a> <a href="/tags/ELK"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>ELK</span></a><a href="/tags/pfSense"><span class="badge tip" style="vertical-align:center;" data-v-0f5ba3f1>pfSense</span></a></div></div> <p>Logstash 的功能像是一個接收器，支援從許多種 Protocol 接收 Log，如 Syslog、Netflow等，並且透過 <strong>Parser</strong> 將<a href="https://en.wikipedia.org/wiki/Unstructured_data" target="_blank" rel="noopener noreferrer">非結構化資料<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>轉換成<a href="https://en.wikipedia.org/wiki/Semi-structured_data" target="_blank" rel="noopener noreferrer">半結構化資料<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。Parser 方便的是使用 Grok Pattern，可以避免自行撰寫複雜的 Regex，不過他也支援 Regex 讓我們可以自訂 Pattern，因此 Logstash 的 parsing 是很彈性的。本系列文章介紹 pfSense 與 ELK Stack (7.6 版) 的整合，藉此分析與收集阻擋的連接紀錄。</p> <h2 id="elk-stack-整合-pfsense-系列文"><a href="#elk-stack-整合-pfsense-系列文" class="header-anchor">#</a> ELK Stack 整合 pfSense 系列文</h2> <ul><li>[本篇] ELK Stack 整合 pfSense (一)：將 pfSense 防火牆阻擋紀錄傳送到 Logstash</li> <li><a href="/posts/infra/elasticsearch-receives-data-from-logstash">ELK Stack 整合 pfSense (二)：Elasticsearch</a></li> <li><a href="/posts/infra/monitoring-pfsense-via-kibana.html">ELK Stack 整合 pfSense (三)：Kibana Dashboard</a></li></ul> <h2 id="安裝-logstash"><a href="#安裝-logstash" class="header-anchor">#</a> 安裝 Logstash</h2> <p>裝 logstash 前需要先安裝 Java，注意一下 Logstash 和 Java 的相容性。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 安裝 JRE</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> default-jre -y
java -version
<span class="token comment"># 安裝 logstash</span>
<span class="token function">curl</span> -L -O https://artifacts.elastic.co/downloads/logstash/logstash-7.6.1.deb
<span class="token function">sudo</span> dpkg -i logstash-7.6.1.deb
</code></pre></div><h2 id="logstash-的檔案結構"><a href="#logstash-的檔案結構" class="header-anchor">#</a> Logstash 的檔案結構</h2> <p>請見<a href="https://www.elastic.co/guide/en/logstash/7.6/dir-layout.html#deb-layout" target="_blank" rel="noopener noreferrer">文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中有詳情，這邊主要是了解 Logstash 各種設定放在哪裡，以及他們有不同的作用。</p> <p><code>/etc/logstash/</code> 底下有各種 <code>yml</code> 檔，都是 logstash 的設定檔。下面說明設定檔的功能。</p> <h3 id="pipeline-yml"><a href="#pipeline-yml" class="header-anchor">#</a> <code>pipeline.yml</code></h3> <p><code>/etc/logstash/pipelines.yml</code> 決定 logstash pipeline config 的路徑，預設在 <code>/etc/logstash/conf.d/*.conf</code> 下，這邊使用預設即可。</p> <h3 id="logstash-yml"><a href="#logstash-yml" class="header-anchor">#</a> <code>logstash.yml</code></h3> <p><code>logstash.yml</code> 用來設定 logstash 執行時的選項，<code>logstash.yml</code> 中大部分的設定也可以在執行指令用 <a href="https://www.elastic.co/guide/en/logstash/7.6/running-logstash-command-line.html#command-line-flags" target="_blank" rel="noopener noreferrer">Command-line Flags<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 帶入。</p> <h3 id="config-file"><a href="#config-file" class="header-anchor">#</a> Config File</h3> <p>這邊是 Logstash 最重要的地方，所有 config 預設都要放在 <code>/etc/logstash/conf.d</code> 底下。我們只要在這裡建立一個 <code>.conf</code> 結尾的檔案就可以寫設定了。如果有多個 config file，則 Logstash 會自行整合。</p> <p>Config File 的結構分為 3 個部分，<code>input</code>、<code>filter</code>、<code>output</code>。Logstash 有需要的話要安裝 plugin，plugin 有四種：<a href="https://www.elastic.co/guide/en/logstash/7.6/input-plugins.html" target="_blank" rel="noopener noreferrer"><code>input</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://www.elastic.co/guide/en/logstash/7.6/filter-plugins.html" target="_blank" rel="noopener noreferrer"><code>filter</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://www.elastic.co/guide/en/logstash/7.6/output-plugins.html" target="_blank" rel="noopener noreferrer"><code>output</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://www.elastic.co/guide/en/logstash/7.6/codec-plugins.html" target="_blank" rel="noopener noreferrer"><code>codec</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。要查看已安裝的 plugin 可以透過指令 <code>bin/logstash-plugin list</code>，<code>bin</code>的路徑會因OS而不同，<a href="#Logstash%20%E7%9A%84%E6%AA%94%E6%A1%88%E7%B5%90%E6%A7%8B">Logstash 的檔案結構文件</a>文件有寫。</p> <h3 id="bin-檔"><a href="#bin-檔" class="header-anchor">#</a> <code>bin</code> 檔</h3> <p>放在 <code>/usr/share/logstash/bin</code>。執行 Logstash、安裝其他 Plugin 等會需要用到這裡的 binary。</p> <h3 id="custom-grok-patterns"><a href="#custom-grok-patterns" class="header-anchor">#</a> Custom Grok Patterns</h3> <p>有時我們需要自行定義 Grok Pattern，並且命名之，這可以透過<code>.grok</code> file 進行定義，然後再從 config file 中指定 pattern 的路徑。</p> <h2 id="在-pfsense-設定-syslog-的-remote-log-server"><a href="#在-pfsense-設定-syslog-的-remote-log-server" class="header-anchor">#</a> 在 pfSense 設定 Syslog 的 Remote log server</h2> <p>在 pfSense 的選單中進入 <strong>Status</strong> &gt; <strong>System Logs</strong>。</p> <p><img alt="" data-src="https://i.imgur.com/bmoFsdy.png" loading="lazy" class="lazy"></p> <p>接著切換到 <strong>Settings</strong> 標籤：</p> <p><img alt="" data-src="https://i.imgur.com/zppua11.png" loading="lazy" class="lazy"></p> <p>輸入 Logstash 的 IP 和 Port：</p> <p><img alt="" data-src="https://i.imgur.com/INCTORj.png" loading="lazy" class="lazy"></p> <h2 id="建立-config-file-和-grok-patttern"><a href="#建立-config-file-和-grok-patttern" class="header-anchor">#</a> 建立 Config file 和 Grok Patttern</h2> <p>我找到 Github 上已經有勇者寫好 pfSense 的 Grok pattern 了，所以直接拿來使用，把整個 <a href="https://github.com/patrickjennings/logstash-pfSense" target="_blank" rel="noopener noreferrer">Repo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 給<code>clone</code>下來吧。</p> <p>如果要新增更多自己的 Pattern，很多人會使用 <a href="https://grokdebug.herokuapp.com/" target="_blank" rel="noopener noreferrer">Grok Debugger<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 進行除錯。</p> <p><img alt="" data-src="https://i.imgur.com/zLrOWa5.png" loading="lazy" class="lazy"></p> <p>最上面就是輸入原始的 Log；中間的欄位輸入 Grok Pattern；如果有額外定義的 custom pattern (像 <code>logstash-pfSense/patterns</code> 裡的內容就是 custom pattern)，請將 <strong>Add custom patterns</strong> 打勾就會可以輸入了。最下方就是預覽 Parsed 後的結果。</p> <p><code>logstash-pfSense/conf.d</code> 裡的檔案複製到<code>/etc/logstash/conf.d</code>，<code>logstash-pfSense/patterns</code>複製到 <code>etc/logstash/patterns</code>。記得修改<code>01-inputs.conf</code>的 port 和<code>10-syslog.conf</code>的 IP，須對應到 pfSense 的 syslog 設定。還有<code>30-outputs.conf</code>的 Elasticsearch host IP。</p> <h4 id="_01-inputs-conf"><a href="#_01-inputs-conf" class="header-anchor">#</a> <code>01-inputs.conf</code></h4> <p>例子使用 Port <code>6514</code></p> <div class="language-conf extra-class"><pre class="language-text"><code>#tcp syslog stream via 5140
input {
  tcp {
    type =&gt; &quot;syslog&quot;
    port =&gt; 6514
  }
}
#udp syslogs stream via 5140
input {
  udp {
    type =&gt; &quot;syslog&quot;
    port =&gt; 6514
  }
}
</code></pre></div><h4 id="_10-syslog-conf-前半段"><a href="#_10-syslog-conf-前半段" class="header-anchor">#</a> <code>10-syslog.conf</code> 前半段</h4> <div class="language-conf extra-class"><pre class="language-text"><code>filter {
  if [type] == &quot;syslog&quot; {
    #change to pfSense ip address
    if [host] =~ /172\.30\.0\.1/ { # 這邊要修改
      mutate {
        add_tag =&gt; [&quot;pfSense&quot;, &quot;Ready&quot;]
      }
    }
    if &quot;Ready&quot; not in [tags] {
      mutate {
        add_tag =&gt; [ &quot;syslog&quot; ]
      }
    }
  }
}
</code></pre></div><p><strong>架 ELK 需要特別注意服務之間溝通的 Port</strong>，預設 <strong>Elasticsearch</strong> 會使用 <mark>Port <code>9200</code></mark> 來接收 Logstash 的資料，因此<code>30-outputs.conf</code>的設定請參考下面：</p> <h4 id="_30-outputs-conf"><a href="#_30-outputs-conf" class="header-anchor">#</a> <code>30-outputs.conf</code></h4> <div class="language-conf extra-class"><pre class="language-text"><code>output {
  if [type] == &quot;syslog&quot; {
    elasticsearch {
        hosts =&gt; &quot;172.30.0.5:9200&quot;
        index =&gt; &quot;logstash-pfSense-%{+YYYY.MM.dd}&quot;
    }
    stdout { codec =&gt; rubydebug }
  }
}
</code></pre></div><p>接著啟動 Logstash。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">service</span> logstash start
</code></pre></div><p>如何確定 Logstash 有接收到 Syslog?
確認 OS 有 Listen 我設定的 Port <code>6514</code> 後，我是使用 TCPDump 查看，因為目前還沒架起 Elasticsearch，所以用很原始的方式看。</p> <p><img alt="" data-src="https://i.imgur.com/AqOehqC.png" loading="lazy" class="lazy"></p> <p>要驗證 Log 被 parse 的結果，可以從 Wireshark 複製 log 內容，到 Grok Debugger 試試看套用 pattern。接著下一篇就是架 Elasticsearch。</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li><a href="https://www.elastic.co/guide/en/logstash/7.6/configuration-file-structure.html" target="_blank" rel="noopener noreferrer">Structure of a Config File | Logstash Reference [7.6] | Elastic<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.netgate.com/pfSense/en/latest/book/monitoring/remote-logging.html" target="_blank" rel="noopener noreferrer">System Monitoring — Remote Logging with Syslog | pfSense Documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/patrickjennings/logstash-pfSense" target="_blank" rel="noopener noreferrer">patrickjennings/logstash-pfSense: Logstash configuration for pfSense syslog events.<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div id="disqus_thread"></div></div> <!----> </main> <footer><div>
      Copyright © 2019-present Li Yen Tseng, Powered by <a href="http://vuepress.vuejs.org">VuePress</a></div></footer></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.d9dd9f6f.js" defer></script><script src="/assets/js/2.91151622.js" defer></script><script src="/assets/js/3.65100333.js" defer></script><script src="/assets/js/16.564ab575.js" defer></script>
  </body>
</html>
