(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{246:function(t,e,r){"use strict";r.r(e);var s=r(0),a=Object(s.a)({},(function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[r("h1",{attrs:{id:"實驗室自架-lab-環境-—-網路架構設計"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#實驗室自架-lab-環境-—-網路架構設計"}},[t._v("#")]),t._v(" 實驗室自架 Lab 環境 — 網路架構設計")]),t._v(" "),r("PageEdit"),t._v(" "),r("div",[r("TagLinks")],1),t._v(" "),r("p",[r("img",{attrs:{src:"https://i.imgur.com/UhT17Yp.png",alt:""}})]),t._v(" "),r("p",[t._v("前陣子學校電腦教室汰換之電腦，有幾台送給實驗室利用，我藉這個機會使用那些資源"),r("router-link",{attrs:{to:"/posts/infra/self-hosted-esxi-server-in-lab.html"}},[t._v("架設一台 ESXi")]),t._v("。架設完成後，接下來考量到一些需求與環境因素，開始設計網路的架構。這篇會使用 "),r("a",{attrs:{href:"https://www.pfsense.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("pfSense"),r("OutboundLink")],1),t._v("、OpenVPN、ESXi 伺服器和一台 Cisco 2950 Switch，進行網路架構設計。")],1),t._v(" "),r("h2",{attrs:{id:"需求與現有環境"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#需求與現有環境"}},[t._v("#")]),t._v(" 需求與現有環境")]),t._v(" "),r("p",[t._v("對於 Lab 環境的幾項需求，分別如下：")]),t._v(" "),r("ol",[r("li",[t._v("所有 VM 皆可連接外網，因為如 "),r("a",{attrs:{href:"https://www.eve-ng.net/",target:"_blank",rel:"noopener noreferrer"}},[t._v("EVE-NG"),r("OutboundLink")],1),t._v(" 在安裝時便需要連接外部下載 Package")]),t._v(" "),r("li",[t._v("對於 VM 的 DHCP，如果伺服器提供讓一些同學使用，在上面佈建的 VM 有 DHCP 較方便")]),t._v(" "),r("li",[t._v("能夠從校內與校外網路 VPN 進入 Lab 環境")]),t._v(" "),r("li",[r("mark",[t._v("不能")]),t._v("直接從 WAN 連到 ESXi 的管理介面")]),t._v(" "),r("li",[t._v("可以透過 VPN 間接連到管理介面")]),t._v(" "),r("li",[t._v("如果使用實驗室裡面的電腦存取伺服器，無須繞過學校的網段，可透過自己的 LAN 直連")]),t._v(" "),r("li",[t._v("必要的話始可使用 Port Forwarding")])]),t._v(" "),r("p",[t._v("現有環境有一些限制，不過不成問題：")]),t._v(" "),r("ol",[r("li",[t._v("學校的網管系統，綁定學校 Public IP 與 MAC")]),t._v(" "),r("li",[t._v("要進行遠端，只能使用 RDP，Team Viewer 與 Google Remote Desktop 皆會被擋")])]),t._v(" "),r("h2",{attrs:{id:"架構圖"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#架構圖"}},[t._v("#")]),t._v(" 架構圖")]),t._v(" "),r("p",[t._v("規劃時，我畫了一張架構圖，方便日後管理與交接。")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://i.imgur.com/ZJ8IsOX.png",alt:""}})]),t._v(" "),r("p",[t._v("由於 Server 的主機板原本就帶有兩個網路介面，因此可以使用 pfSense，將一個 NIC 作為 WAN，另一個做為 LAN。pfSense 在架構中擔任 Firewall 與 Router 的腳色，提供包含 NAT、Routing、VPN 和 DHCP Sever的功能。因為我只跟學校要到一個 IP，不想買一台 Firewall，所以 pfSense 就是首選。")]),t._v(" "),r("h2",{attrs:{id:"cisco-switch-設定"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#cisco-switch-設定"}},[t._v("#")]),t._v(" Cisco Switch 設定")]),t._v(" "),r("p",[t._v("Switch 的設定非常簡單，我透過 VLAN 拆分成邏輯上的兩台不同的交換器，一個負責 LAN，同時是交換器的管理 VLAN;另一個連接學網對外(Uplink)與 Server 規劃的 WAN 端。")]),t._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[t._v("# int ra fa 0/1 - 12\n(config-if)# sw mode access\n(config-if)# sw access vl 10\n# int ra fa 0/13 - 24\n(config-if)# sw mode access\n")])])]),r("p",[t._v("但是第24 port 要接到學校的 Swich，我怕對端有設定"),r("a",{attrs:{href:"https://www.cisco.com/c/en/us/support/docs/lan-switching/spanning-tree-protocol/10586-65.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("BPDU Guard"),r("OutboundLink")],1),t._v("，因此特定對該port開啟 "),r("strong",[t._v("BPDU filter")]),t._v("，阻止我的交換器發出 BPDU。")]),t._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[t._v("# int fa0/24\n(config-if)# spanning-tree bpdufilter en\n")])])]),r("p",[t._v("同時將 VTP 的模式切換成 Transparent，總之，避免一切私接 Switch 對學校網路的影響。")]),t._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[t._v("# vtp mode transparent\n")])])]),r("h2",{attrs:{id:"安裝-pfsense"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#安裝-pfsense"}},[t._v("#")]),t._v(" 安裝 pfSense")]),t._v(" "),r("p",[t._v("安裝 pfSense 的過程參考自"),r("a",{attrs:{href:"https://docs.netgate.com/pfsense/en/latest/virtualization/virtualizing-pfsense-with-vmware-vsphere-esxi.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文件"),r("OutboundLink")],1),t._v("，這邊順便翻譯以內化學習。")]),t._v(" "),r("h3",{attrs:{id:"vsphere-網路設定"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#vsphere-網路設定"}},[t._v("#")]),t._v(" vSphere 網路設定")]),t._v(" "),r("p",[t._v("在建立 VM 前，需要在 ESXi 上新增2個 vSwitch 和兩個連接埠群組(Port Group)，一個做為 WAN，另一個作為 LAN。")]),t._v(" "),r("p",[t._v("在左側選擇「網路」，切換至「虛擬交換器」標籤，「新增虛擬交換器」。\n"),r("img",{attrs:{src:"https://i.imgur.com/i0F9jVg.png",alt:""}})]),t._v(" "),r("p",[t._v("圖中是把 vSwitch0 作為 LAN，兩個 vSwitch 分別連接到不同的實體介面。\n"),r("img",{attrs:{src:"https://i.imgur.com/3Ss6AYf.png",alt:""}})]),t._v(" "),r("h3",{attrs:{id:"建立連接埠群組"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#建立連接埠群組"}},[t._v("#")]),t._v(" 建立連接埠群組")]),t._v(" "),r("p",[t._v("切換到「連接埠群組」標籤，新增兩個群組，分別連接到 LAN 和 WAN 兩個 vSwitch。\n"),r("img",{attrs:{src:"https://i.imgur.com/ZkamIQ0.png",alt:""}})]),t._v(" "),r("h3",{attrs:{id:"建立-pfsense-vm"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#建立-pfsense-vm"}},[t._v("#")]),t._v(" 建立 pfSense VM")]),t._v(" "),r("p",[t._v("到"),r("a",{attrs:{href:"https://www.pfsense.org/download/",target:"_blank",rel:"noopener noreferrer"}},[t._v("這裡"),r("OutboundLink")],1),t._v("下載映像檔，64位元系統請選「AMD64」，下面選「CD Image (ISO) Installer」。其餘步驟和一般架設 VM 是一樣的。注意 VM 的網卡，種類選 "),r("strong",[t._v("VMXNET 3")]),t._v(" 的效能最好，但是第一次啟動時要手動選擇 LAN/WAN 介面。")]),t._v(" "),r("p",[t._v("接著開啟 VM，看到以下畫面\n"),r("img",{attrs:{src:"https://i.imgur.com/QPqVEb0.png",alt:""}})]),t._v(" "),r("p",[t._v("當看到下面畫面時，可以先輸入 2 設定 IP 了。\n"),r("img",{attrs:{src:"https://i.imgur.com/HOQa7G1.png",alt:""}})]),t._v(" "),r("p",[t._v("接著連入 pfSense 的 Web UI，預設登入帳密是 "),r("code",[t._v("admin")]),t._v("，密碼"),r("code",[t._v("pfsense")]),t._v("，安全考量，請一定要更改預設密碼。接著就可以安裝 VMware tools。")]),t._v(" "),r("p",[t._v("不過我的環境是學網，DNS 必須使用學校所規定的，能夠成功解析地址才能讓 Package Manager 連得上。")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://i.imgur.com/BIj7Tp8.png",alt:""}})]),t._v(" "),r("p",[t._v("安裝 VMware tools。切換到 Available Packages 標籤，搜尋 Open-vm-tools\n"),r("img",{attrs:{src:"https://i.imgur.com/Ce7ASRq.png",alt:""}})]),t._v(" "),r("h2",{attrs:{id:"設定-openvpn"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#設定-openvpn"}},[t._v("#")]),t._v(" 設定 OpenVPN")]),t._v(" "),r("p",[t._v("這裡一樣是翻譯自"),r("a",{attrs:{href:"https://docs.netgate.com/pfsense/en/latest/vpn/openvpn/openvpn-remote-access-server.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("文件"),r("OutboundLink")],1),t._v("。")]),t._v(" "),r("p",[t._v("這邊使用的是「最基本」的設定，使用 local user 的帳密進行驗證。pfSense 的 "),r("strong",[t._v("VPN > OpenVPN")]),t._v(" 底下，有 "),r("strong",[t._v("Wizard")]),t._v(" 的選項，是比較簡易設置 VPN 的方式。第一步選擇 "),r("strong",[t._v("Local User Access")]),t._v("，User 可以到 "),r("strong",[t._v("System > User Manager")]),t._v(" 新增。")]),t._v(" "),r("h3",{attrs:{id:"新增-ca-憑證"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#新增-ca-憑證"}},[t._v("#")]),t._v(" 新增 CA 憑證")]),t._v(" "),r("p",[t._v("接著新增一個自簽憑證，設定可以參考下面\n"),r("img",{attrs:{src:"https://i.imgur.com/NjQnhtu.png",alt:""}})]),t._v(" "),r("h3",{attrs:{id:"新增-server-憑證"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#新增-server-憑證"}},[t._v("#")]),t._v(" 新增 Server 憑證")]),t._v(" "),r("p",[t._v("資料和 CA 的類似\n"),r("img",{attrs:{src:"https://i.imgur.com/WISRLsL.png",alt:""}})]),t._v(" "),r("h3",{attrs:{id:"openvpn-server-設定"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#openvpn-server-設定"}},[t._v("#")]),t._v(" OpenVPN Server 設定")]),t._v(" "),r("ul",[r("li",[r("strong",[t._v("TLS Authentication")]),t._v(" 請打勾")]),t._v(" "),r("li",[r("strong",[t._v("Tunnel Network")]),t._v(" 請輸入一個網段，該網段不能存在於現有網路和路由表中。")]),t._v(" "),r("li",[r("strong",[t._v("Local Network")]),t._v(" 就是 VPN 進來後可以存取的網段，依照上面的架構圖就是 "),r("code",[t._v("172.30.0.0/24")]),t._v("。")])]),t._v(" "),r("p",[t._v("接著下一步。")]),t._v(" "),r("h3",{attrs:{id:"firewall-rules"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#firewall-rules"}},[t._v("#")]),t._v(" Firewall Rules")]),t._v(" "),r("p",[t._v("底下兩個選項都打勾，否則不會通。")]),t._v(" "),r("p",[t._v("接著設定便完成了。到 "),r("strong",[t._v("Firewall > rules")]),t._v(" 確認防火牆規則有沒有新增一條規則：Source any 到 destination WAN，port 則是剛才設定中的 OpneVPN port，預設是"),r("code",[t._v("1194")]),t._v("。")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://i.imgur.com/GhKawlB.png",alt:""}})]),t._v(" "),r("h3",{attrs:{id:"新增-user"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#新增-user"}},[t._v("#")]),t._v(" 新增 User")]),t._v(" "),r("p",[r("strong",[t._v("System > User Manager")]),t._v(" 底下，選+號新增 user ，CA 請選擇剛才建立的。")]),t._v(" "),r("h3",{attrs:{id:"openvpn-client-export-package"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#openvpn-client-export-package"}},[t._v("#")]),t._v(" OpenVPN Client Export Package")]),t._v(" "),r("p",[t._v("這個工具非常好用，它可以針對特定使用者，輸出一個安裝檔(帶有使用者和這個VPN的相關設定)，所以使用者只要安裝完即可使用。")]),t._v(" "),r("p",[t._v("到 "),r("strong",[t._v("System > Packages, Available Packages")]),t._v(" 標籤，搜尋 openvpn，安裝 "),r("strong",[t._v("OpenVPN Client Export Package")]),t._v("。")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://i.imgur.com/Uk82ibO.png",alt:""}})]),t._v(" "),r("p",[t._v("接著到 "),r("strong",[t._v("VPN > OpenVPN, Client Export")]),t._v("標籤底下，會發現剛才建立的使用者。")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://i.imgur.com/TuQJciw.png",alt:""}})]),t._v(" "),r("p",[t._v("如果是 Windows，下載"),r("strong",[t._v("Current Windows Installer")]),t._v("底下的選項，給 User 安裝即可。"),r("mark",[t._v("千萬不要")]),t._v("單獨下載設定檔，另外安裝 OpenVPN Client 然後輸入設定，我嘗試過這樣\n會失敗。盡量使用 Installer。")]),t._v(" "),r("h2",{attrs:{id:"結語"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#結語"}},[t._v("#")]),t._v(" 結語")]),t._v(" "),r("p",[t._v("目前完成了 Lab 的架構，所有網路需求也達成了。我可以從任何地方 VPN 到我的 LAN，登入 ESXi 介面，甚至可以對實體的 Cisco Switch 進行設定。如果需要上傳龐大的 Image，我可以遠端到我的 Lab PC，作為跳板機，從該 PC 透過 LAN 上傳檔案至 Server 而不會消耗 WAN 流量。而日後任何新的 VM 被建立，也都可以自動取得 IP 和指定的 DNS resolver，已達成更新與安裝 Packages。")]),t._v(" "),r("Disqus")],1)}),[],!1,null,null,null);e.default=a.exports}}]);