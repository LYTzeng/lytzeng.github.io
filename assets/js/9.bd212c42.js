(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{360:function(t,a,s){"use strict";s.r(a);var e=s(1),r=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"透過-aws-lambda、api-gateway-和-aws-go-sdk，從-mattermost-查看-開關-ec2-instances"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#透過-aws-lambda、api-gateway-和-aws-go-sdk，從-mattermost-查看-開關-ec2-instances"}},[t._v("#")]),t._v(" 透過 AWS Lambda、API Gateway 和 AWS Go SDK，從 Mattermost 查看/開關 EC2 Instances")]),t._v(" "),s("PageEdit"),t._v(" "),s("div",[s("TagLinks")],1),t._v("\n目前我實習的公司使用 Mattermost 作為內部通訊軟體，且 Mattermost 支援 Webhook 和 Slash Command。為了方便隨時隨地可以快速開啟/關閉 EC2，因此想寫一個下 Slash Command 指令的工具，直接呼叫 API 來控制和查看 EC2，免去登入 console 的麻煩，一定會方便許多。整體架構如下。\n"),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"/images/aws/lambda-apigateway-mattermost-go-ec2-1.jpg",loading:"lazy"}})]),t._v(" "),s("p",[t._v("我使用 Go 寫了一個程式處理 Mattermost 傳入的資料，並且透過 "),s("a",{attrs:{href:"https://github.com/aws/aws-sdk-go",target:"_blank",rel:"noopener noreferrer"}},[t._v("aws-sdk-go"),s("OutboundLink")],1),t._v(" 對 EC2 進行操作。程式會在 Lambda 上執行，原始碼請參考我的 Github："),s("a",{attrs:{href:"https://github.com/LYTzeng/ec2ctl",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/LYTzeng/ec2ctl"),s("OutboundLink")],1),t._v("，日後考慮用 CloudFormation 讓需要的人快速佈署。這篇主要會介紹 API Gateway、Lambda 和部份 SDK 的使用。")]),t._v(" "),s("p",[t._v("先展示成果：")]),t._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/PEndaZv.gif",loading:"lazy"}})]),t._v(" "),s("h2",{attrs:{id:"api-gateway"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#api-gateway"}},[t._v("#")]),t._v(" API Gateway")]),t._v(" "),s("h3",{attrs:{id:"iam-role"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#iam-role"}},[t._v("#")]),t._v(" IAM Role")]),t._v(" "),s("p",[t._v("在建立一個 API 之前，我們先創一個 IAM Policy 並 Attach 到 Role。API Gateway 需要 Invoke Lambda 以及寫入 CLoudWatch 的權限。\n進入 IAM 管理介面，首先 Create 一個 Policy 使其允許 Invoke Lambda，我們使用 JSON 來建立 Policy：")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Version"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2012-10-17"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Statement"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Sid"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"VisualEditor0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Effect"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Allow"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Action"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lambda:InvokeFunction"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lambda:PutFunctionEventInvokeConfig"')]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Resource"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("接著建立一個 Role 並 "),s("strong",[t._v("Attach policies")]),t._v("。除了 attach 剛才建立的 policy，還需要 attach 一個 "),s("code",[t._v("AmazonAPIGatewayPushToCloudWatchLogs")]),t._v(" 的 policy，可以直接搜尋，順便將 "),s("strong",[t._v("Role ARN")]),t._v("複製下來，之後會使用到。接下來就可以建立一個 API。")]),t._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/QmuRVgE.png",loading:"lazy"}})]),t._v(" "),s("h3",{attrs:{id:"建立-api-gateway"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#建立-api-gateway"}},[t._v("#")]),t._v(" 建立 API Gateway")]),t._v(" "),s("p",[t._v("進入 API Gateway 介面，選擇 "),s("strong",[t._v("Create API")]),t._v("，找到 "),s("strong",[t._v("REST API")]),t._v(" 選擇 Build，"),s("strong",[t._v("Choose the protocol")]),t._v(" 選 "),s("strong",[t._v("REST")]),t._v("，"),s("strong",[t._v("Create new API")]),t._v(" 選擇 "),s("strong",[t._v("New PIA")]),t._v("。"),s("strong",[t._v("API Name")]),t._v("輸入 API 名稱，"),s("strong",[t._v("Endpoint Type")]),t._v(" 保留預設 "),s("strong",[t._v("Regional")]),t._v(" 即可。")]),t._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/G4IZFLx.png",loading:"lazy"}})]),t._v(" "),s("p",[s("strong",[t._v("Create API")]),t._v(" 後進入 API 設定的頁面。選擇左側選單最下面的 "),s("strong",[t._v("Settings")]),t._v("，將之前複製的 "),s("strong",[t._v("Role ARN")]),t._v(" 貼上，"),s("strong",[t._v("Role ARN")]),t._v(" 就是一個 IAM Role 的 ID，這可以提供 API Gateway 寫入 CloudWatch 的權限。")]),t._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/jhhmCyx.png",loading:"lazy"}})]),t._v(" "),s("p",[t._v("API Gateway 幾個組成元素大概有 "),s("strong",[t._v("Resource")]),t._v("、"),s("strong",[t._v("Method")]),t._v("、"),s("strong",[t._v("Stages")]),t._v(" 和 "),s("strong",[t._v("Resource Policy")]),t._v("，這幾點設置完畢就能有一個可以運作的簡單 API 了。先簡單說明這幾個項目：")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("Resources")]),t._v("\n一個 Resource 可以接收多種的 HTTP request method，例如 GET/POST/OPTION 等等。 Resource 的名稱會包含在 URL 裡面。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("Methods")]),t._v("\nHTTP request 的單一種類，並且決定接收到這個 method 後下一步該做什麼，以及如何做出 response。例如：收到 HTTP POST 時 觸發 Lambda function，並且將 body 傳送至 Lambda，隨後將 Lambda 回傳的 response (如：402 Unauthorized) 回應給 Client。流程會顯示在設定頁面中。\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/jqrJpru.png",loading:"lazy"}})])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("Stages")]),t._v("\nStage 代表這個 API 的開發階段，例如 "),s("code",[t._v("dev, prod, beta, v2")]),t._v("等，要產生一個可以被呼叫的 API，一定要 "),s("strong",[t._v("Deploy")]),t._v(" 到一個 Stage，Stage 的名稱會包含在 URL 中。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("Resource Policy")]),t._v("\n提供 API 存取控制的機制，使用 JSON 格式來設定，條件可以使用 IAM，或是單一主機 IP等，可用來決定\n被允許/禁止的動作，避免被不明人士存取到 API。")])])]),t._v(" "),s("p",[t._v("API Gateway 的 REST API 的 URL 的格式為：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("https://{restapi-id}.execute-api.{region}.amazonaws.com/{stageName}/{resource}\n")])])]),s("p",[t._v("假設我建立一個名為 "),s("code",[t._v("ec2ctl")]),t._v(" 的 "),s("strong",[t._v("resource")]),t._v("，"),s("strong",[t._v("stage")]),t._v(" 為 "),s("code",[t._v("dev")]),t._v("，API 位於 "),s("code",[t._v("us-west-2")]),t._v(" 的 region，則我的 API URL 會是 "),s("code",[t._v("https://{restapi-id}.execute-api.us-west-2.amazonaws.com/dev/ec2ctl")]),t._v(" 。")]),t._v(" "),s("h4",{attrs:{id:"建立-resource"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#建立-resource"}},[t._v("#")]),t._v(" 建立 Resource")]),t._v(" "),s("p",[t._v("左側選單選擇 "),s("strong",[t._v("Resources")]),t._v("，會看到只有"),s("code",[t._v("/")]),t._v("這個符號，代表我們位於 base url，點擊 "),s("strong",[t._v("Action")]),t._v(" > "),s("strong",[t._v("Create Resource")]),t._v(" 建立 Resource，並決定 "),s("strong",[t._v("resource name")]),t._v(" 與 "),s("strong",[t._v("resource path")]),t._v("。\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/IJYR2UF.png",loading:"lazy"}})]),t._v(" "),s("h4",{attrs:{id:"建立-method"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#建立-method"}},[t._v("#")]),t._v(" 建立 Method")]),t._v(" "),s("p",[t._v("選擇 Action > Create Method，並選擇 POST。\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/GImWVwX.png",loading:"lazy"}}),t._v(" "),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/RpvVp6E.png",loading:"lazy"}})]),t._v(" "),s("h4",{attrs:{id:"resource-policy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#resource-policy"}},[t._v("#")]),t._v(" Resource Policy")]),t._v(" "),s("p",[t._v("我們需要允許 API Gateway invoke Lambda funciton，而且只有 Mattermost server 和我們的測試主機的 "),s("strong",[t._v("SourceIp")]),t._v(" 是被允許的，使用 JSON 格式輸入設定。")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Version"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2012-10-17"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Statement"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Effect"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Allow"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Principal"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"AWS"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*"')]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Action"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"execute-api:Invoke"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Resource"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"execute-api:/*/*/ec2ctl"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Condition"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"IpAddress"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"aws:SourceIp"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.0.2.1/32"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.0.2.2/32"')]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"deploy-api-到指定-stage"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deploy-api-到指定-stage"}},[t._v("#")]),t._v(" Deploy API 到指定 Stage")]),t._v(" "),s("p",[t._v("點選左側選單 "),s("strong",[t._v("Resources")]),t._v("，"),s("strong",[t._v("Action")]),t._v(" > "),s("strong",[t._v("Deploy API")]),t._v("，"),s("strong",[t._v("[New Stage]")]),t._v(" 後輸入 stage name，deploy 後即可使用這個 API。\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/IlIV3He.png",loading:"lazy"}})]),t._v(" "),s("p",[t._v("有一點需要特別注意的是，"),s("mark",[t._v("對 API 設定做任何更動後，請記得要重新 "),s("strong",[t._v("Deploy")]),t._v(" 才會生效")]),t._v("。")]),t._v(" "),s("p",[t._v("接著我們需要使用 Lambda 來和 API Gateway 串接。")]),t._v(" "),s("h2",{attrs:{id:"lambda"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lambda"}},[t._v("#")]),t._v(" Lambda")]),t._v(" "),s("h3",{attrs:{id:"iam-role-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#iam-role-2"}},[t._v("#")]),t._v(" IAM Role")]),t._v(" "),s("p",[t._v("我們會使用 Lambda 達成幾項功能：讀取所有 region 的 EC2，並回傳相關資訊，以及開啟/關閉指定的 EC2。要進行這些操作，我們需要賦予 Lambda function 權限，所以須建立 IAM Role。先新增所需的 Policy，JSON 設定請複製這裡：https://gist.github.com/LYTzeng/f935732d160c8fa72e90a18deeed9ae4 ，再將這個 Policy Attach 至新增的 Role。")]),t._v(" "),s("h3",{attrs:{id:"建立-function"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#建立-function"}},[t._v("#")]),t._v(" 建立 Function")]),t._v(" "),s("p",[t._v("到 Lambda 界面，選擇 "),s("strong",[t._v("Create Function")]),t._v("，"),s("strong",[t._v("Runtime")]),t._v(" 選擇 "),s("strong",[t._v("Go 1.x")]),t._v("，"),s("strong",[t._v("Permissions")]),t._v(" 選擇 "),s("strong",[t._v("Use an existing role")]),t._v(" 找到剛才建立的 Role 並套用。")]),t._v(" "),s("p",[t._v("因為這次使用 Go 撰寫程式，必須先 compile 成能夠讓 Linux 執行的 binary (Lambda 底層 OS 使用 Amazon Linux) 並上傳，而且只能寫在 "),s("code",[t._v("package main")]),t._v(" 裡面。你可以直接"),s("a",{attrs:{href:"https://github.com/LYTzeng/ec2ctl/releases/download/0.1.0/main.zip",target:"_blank",rel:"noopener noreferrer"}},[t._v("下載 compile 過的執行檔"),s("OutboundLink")],1),t._v("，透過 console 上傳 "),s("strong",[t._v("Function Package")]),t._v("，"),s("strong",[t._v("Handler")]),t._v(" 設定為 "),s("code",[t._v("main.upx")]),t._v("。")]),t._v(" "),s("p",[t._v("接著找到 "),s("strong",[t._v("Environment Variables")]),t._v(" 區塊新增環境變數，"),s("strong",[t._v("Key")]),t._v(" 請輸入 "),s("code",[t._v("MATTERMOST_TOKEN")]),t._v("，"),s("strong",[t._v("Value")]),t._v(" 為你的 Mattermost server 的 Slash command "),s("strong",[t._v("token")]),t._v("。")]),t._v(" "),s("p",[t._v("接著新增一個 "),s("strong",[t._v("Trigger")]),t._v("：\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/VYJkazR.png",loading:"lazy"}})]),t._v(" "),s("p",[t._v("選擇 "),s("strong",[t._v("API Gateway")]),t._v("，"),s("strong",[t._v("API")]),t._v(" 就是剛才建立的 API，"),s("strong",[t._v("Deployment Stage")]),t._v(" 是剛才 Deploy 時命名的名稱 (如："),s("code",[t._v("dev")]),t._v(")，"),s("strong",[t._v("Security")]),t._v(" 選 "),s("strong",[t._v("Open")]),t._v("，我們已經用 Token 做驗證，加上用 Resource Policy 白名單過濾，不必擔心這個 Open 設定。\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/jheCEwG.png",loading:"lazy"}})]),t._v(" "),s("p",[t._v("接著回到 "),s("strong",[t._v("API Gateway")]),t._v(" 頁面，選擇 "),s("code",[t._v("/ec2ctl")]),t._v(" 底下的 "),s("strong",[t._v("POST")]),t._v("，設定 "),s("strong",[t._v("Integration Request")])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("Integration type")]),t._v(" 為 "),s("strong",[t._v("Lambda Function")])]),t._v(" "),s("li",[s("strong",[t._v("Use Lambda Proxy integration 務必勾選")]),t._v("，此選項可透過 event 將 Request body 傳送至 Lambda。")]),t._v(" "),s("li",[s("strong",[t._v("Lambda Function")]),t._v(" 即剛才建立的 function\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/Js98mml.png",loading:"lazy"}}),t._v("\n儲存後可以看到整個 Method Execution 流程。")])]),t._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/VinbrZD.png",loading:"lazy"}})]),t._v(" "),s("p",[t._v("這樣系統已經建制完畢，接下來可以使用 Postman 進行測試，或是直接在 Mattermost 開發環境測試。")]),t._v(" "),s("h2",{attrs:{id:"mattermost-架設與設定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mattermost-架設與設定"}},[t._v("#")]),t._v(" Mattermost 架設與設定")]),t._v(" "),s("p",[t._v("本篇不會詳述這部份操作，請參考 Mattermost 的官方文件：")]),t._v(" "),s("ul",[s("li",[t._v("開發環境架設\nhttps://developers.mattermost.com/contribute/server/developer-setup/")]),t._v(" "),s("li",[t._v("Slash Command 設定\nhttps://docs.mattermost.com/developer/slash-commands.html\nhttps://developers.mattermost.com/integrate/slash-commands/\nSlash Command 設定可以參考這裡的範例：")])]),t._v(" "),s("blockquote",[s("ul",[s("li",[t._v("Title: "),s("code",[t._v("ec2ctl")])]),t._v(" "),s("li",[t._v("Description: "),s("code",[t._v("Start/stop/list EC2 instances from Mattermost.")])]),t._v(" "),s("li",[t._v("Command Trigger Word: "),s("code",[t._v("ec2ctl")])]),t._v(" "),s("li",[t._v("Request URL: "),s("code",[t._v("https://{restapi-id}.execute-api.{region}.amazonaws.com/dev/ec2ctl")])]),t._v(" "),s("li",[t._v("Request Method: "),s("code",[t._v("POST")])]),t._v(" "),s("li",[t._v("Response Username: "),s("code",[t._v("留空白")])]),t._v(" "),s("li",[t._v("Response Icon: "),s("code",[t._v("留空白")])]),t._v(" "),s("li",[t._v("Autocomplete: ✔")]),t._v(" "),s("li",[t._v("Autocomplete Hint: "),s("code",[t._v("(version | (start | stop) -i <instance id> | ls [-r <region>])")])]),t._v(" "),s("li",[t._v("Autocomplete Description: "),s("code",[t._v("Start/stop/list EC2 instances from Mattermost.")])])])]),t._v(" "),s("p",[t._v("設定完畢請複製 "),s("strong",[t._v("token")]),t._v(" 並貼上至 Lambda 的 Environment Variable "),s("code",[t._v("MATTERMOST_TOKEN")]),t._v(" 中。\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://docs.mattermost.com/_images/slash_commands_token.png",loading:"lazy"}})]),t._v(" "),s("h2",{attrs:{id:"使用-mattermost-測試"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-mattermost-測試"}},[t._v("#")]),t._v(" 使用 Mattermost 測試")]),t._v(" "),s("p",[t._v("此程式 "),s("a",{attrs:{href:"https://github.com/LYTzeng/ec2ctl",target:"_blank",rel:"noopener noreferrer"}},[t._v("ec2ctl"),s("OutboundLink")],1),t._v(" 的 Slash command 規則如下：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Usage:\n    ec2ctl version\n    ec2ctl (stop | start) -i <id>\n    ec2ctl ls [-r <region>]\nOptions:\n    -i <id>    Specify an instance ID.\n    -r <region>    Specify a region.\n")])])]),s("p",[t._v("測試指令是否正常，"),s("code",[t._v("/ec2ctl ls -r us-west-2")]),t._v("輸入後可以看到輸出如下：\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/jaTBuco.png",loading:"lazy"}})]),t._v(" "),s("h2",{attrs:{id:"使用-postman-測試"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-postman-測試"}},[t._v("#")]),t._v(" 使用 Postman 測試")]),t._v(" "),s("p",[t._v("使用 Postman 測試時需要模仿 Mattermost 的 HTTP Request 格式，否則程式會出錯。圖中 Postman 的設置都是必要的參數，不過只須設定 "),s("strong",[t._v("Headers")]),t._v(" 以及 "),s("strong",[t._v("Body")]),t._v("：")]),t._v(" "),s("p",[s("strong",[t._v("Content-Type")]),t._v("："),s("code",[t._v("application/x-www-from-urlencoded")]),t._v(" "),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/JhnYTU2.png",loading:"lazy"}})]),t._v(" "),s("p",[s("strong",[t._v("token")]),t._v(" 為 Mattermost slash command token\n"),s("strong",[t._v("text")]),t._v(" 欄位就是指令的內容 （不含 slash command 的 trigger "),s("code",[t._v("/ec2ctl")]),t._v("），例如"),s("code",[t._v("ls -r us-west-2")]),t._v(" 或 "),s("code",[t._v("stop -i i-134134fwifi")]),t._v("。\n"),s("strong",[t._v("user_name")]),t._v(" 請隨意輸入\n"),s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/1l8ueF8.png",loading:"lazy"}})]),t._v(" "),s("p",[t._v("若看到 "),s("code",[t._v("Status: 200 OK")]),t._v(" 和一些內容，代表成功了。")]),t._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://i.imgur.com/c2t7NUi.png",loading:"lazy"}})]),t._v(" "),s("h2",{attrs:{id:"references"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[t._v("#")]),t._v(" References")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("IAM JSON Policy Reference "),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-deploy-api.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Deploying a REST API in Amazon API Gateway"),s("OutboundLink")],1)])])],1)}),[],!1,null,null,null);a.default=r.exports}}]);